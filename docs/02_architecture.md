# のびレコ システムアーキテクチャ

## 📋 目次

1. [技術スタック](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#1-%E6%8A%80%E8%A1%93%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF)
2. [アーキテクチャ概要](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#2-%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E6%A6%82%E8%A6%81)
3. [システム構成図](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#3-%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E6%A7%8B%E6%88%90%E5%9B%B3)
4. [開発方針](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#4-%E9%96%8B%E7%99%BA%E6%96%B9%E9%87%9D)
5. [技術選定理由](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#5-%E6%8A%80%E8%A1%93%E9%81%B8%E5%AE%9A%E7%90%86%E7%94%B1)
6. [データベース設計方針](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#6-%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E8%A8%AD%E8%A8%88%E6%96%B9%E9%87%9D)

---

## 1. 技術スタック

### 1.1 技術スタック一覧

MVP（実用最小限の製品）を最速で立ち上げつつ、将来の拡張にも耐える構成です。

|レイヤー|技術・サービス|選定理由|
|:--|:--|:--|
|**フロントエンド**|**Next.js (React)**|・Web/スマホ両対応のUI構築に最適<br>・画面遷移が高速で、アプリのような操作感を実現可能<br>・開発者人口が多く採用・引き継ぎが容易|
|**言語**|**TypeScript**|・型定義により、「施設IDの間違い」などのバグを未然に防ぐ<br>・AIの入出力データ構造を厳密に定義できる|
|**バックエンド**|**Next.js API Routes**<br>(または Node.js / Go)|・フロントエンドと同じ言語で記述でき、開発効率が高い<br>・初期はNext.js内に統合し、規模拡大時に切り出し可能|
|**データベース**|**PostgreSQL**|・「組織 > 施設 > クラス > 児童」という複雑な階層構造（リレーショナルデータ）の管理に必須<br>・JSON型をサポートしており、AI生成結果の柔軟な保存にも対応|
|**インフラ/BaaS**|**Supabase**|・**推奨**。PostgreSQL、認証、ファイル保存がセットになったBaaS<br>・開発工数を大幅（3〜5割）削減できる<br>・AWS等への移行も可能なオープンソースベース|
|**AIモデル**|**OpenAI GPT-4o-mini**|・「GPT-4o」の軽量版<br>・文章抽出・要約タスクにおいて、コストと精度のバランスが現在最強<br>・日本語処理能力が高い|

### 1.2 補足技術

|用途|技術|備考|
|:--|:--|:--|
|**リアルタイム編集**|WebSocket / Supabase Realtime|複数職員による同時編集機能の実現|
|**音声入力**|Web Speech API / 外部API|活動記録入力の効率化|
|**QRコード**|QRコード生成・読み取りライブラリ|出欠管理の自動化|
|**ファイルストレージ**|Supabase Storage|子どもの写真、活動写真の保存|
|**CSV処理**|Papaparse / SheetJS|データインポート・エクスポート|

---

## 2. アーキテクチャ概要

### 2.1 システム構成の基本方針

```
クライアント（ブラウザ）
    ↓
Next.js（フロントエンド + API）
    ↓
Supabase（PostgreSQL + 認証 + Storage）
    ↓
OpenAI API（AI機能）
```

### 2.2 レイヤー構成

#### フロントエンド層

- **責務**: UI表示、ユーザー入力処理、状態管理
- **主な技術**: Next.js, React, TypeScript
- **特徴**:
    - サーバーサイドレンダリング（SSR）による高速表示
    - クライアントサイドルーティングによるアプリライクな操作感

#### API層

- **責務**: ビジネスロジック、データ検証、外部API連携
- **主な技術**: Next.js API Routes
- **特徴**:
    - RESTful API設計
    - 認証・認可のミドルウェア処理
    - AI API呼び出しの抽象化

#### データ層

- **責務**: データ永続化、トランザクション管理
- **主な技術**: PostgreSQL (Supabase)
- **特徴**:
    - リレーショナルデータの厳密な管理
    - JSON型によるフレキシブルなデータ保存
    - Row Level Security（RLS）による権限制御

---

## 3. システム構成図

### 3.1 全体構成図

```
┌─────────────────────────────────────────────────────────┐
│                    クライアント                          │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                │
│  │   PC    │  │ タブレット│  │スマホ   │                │
│  └─────────┘  └─────────┘  └─────────┘                │
└──────────────────┬──────────────────────────────────────┘
                   │ HTTPS
                   ↓
┌─────────────────────────────────────────────────────────┐
│                  Next.js Application                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │         フロントエンド (React)                    │  │
│  │  ・画面描画 ・状態管理 ・ルーティング             │  │
│  └──────────────────────────────────────────────────┘  │
│                         ↕                                │
│  ┌──────────────────────────────────────────────────┐  │
│  │         API Routes (バックエンド)                 │  │
│  │  ・認証 ・ビジネスロジック ・データ検証           │  │
│  └──────────────────────────────────────────────────┘  │
└──────────────────┬──────────────────────────────────────┘
                   │
        ┌──────────┴──────────┐
        ↓                     ↓
┌────────────────┐    ┌────────────────┐
│   Supabase     │    │  OpenAI API    │
│                │    │                │
│ ・PostgreSQL   │    │ ・GPT-4o-mini  │
│ ・認証         │    │ ・記録要約     │
│ ・Storage      │    │ ・タグ自動付与 │
│ ・Realtime     │    │                │
└────────────────┘    └────────────────┘
```

### 3.2 データフロー（活動記録入力の例）

```
1. 職員が活動記録を入力
   ↓
2. Next.js フロントエンドで入力受付
   ↓
3. API Routes で検証・整形
   ↓
4. Supabase PostgreSQL に保存
   ↓
5. Supabase Realtime で他の職員に通知（リアルタイム編集）
   ↓
6. （オプション）OpenAI API でタグ自動付与
```

---

## 4. 開発方針

### 4.1 段階的な開発アプローチ

#### フェーズ1: MVP（最小限の動くプロトタイプ）

- **目標**: コア機能を1つ完成させる
- **対象機能**:
    - `/records/activity`（活動記録入力）
    - リアルタイム編集の検証
- **期間**: 1〜2週間

#### フェーズ2: 主要機能の実装

- **目標**: 日常業務に必要な機能を揃える
- **対象機能**:
    - `/dashboard`（ダッシュボード）
    - `/attendance/schedule`（出席予定登録）
    - `/children/:id`（子ども詳細）
- **期間**: 2〜3週間

#### フェーズ3: 拡張機能の実装

- **目標**: 差別化機能を追加
- **対象機能**:
    - AI による記録要約
    - 成長サマリ・グラフ表示
    - レポート自動生成
- **期間**: 3〜4週間

### 4.2 技術的な優先順位

#### 最優先（リスク検証）

1. **リアルタイム編集**の技術検証
    
    - WebSocket または Supabase Realtime
    - 複数人同時編集時の競合解決
2. **データベース設計**
    
    - ER図作成
    - 正規化と非正規化のバランス

#### 高優先（MVP必須）

3. **認証・権限管理**
    
    - Supabase Auth の導入
    - ロールベースアクセス制御（RBAC）
4. **基本的なCRUD操作**
    
    - 活動記録の作成・読取・更新・削除

#### 中優先（差別化要素）

5. **音声入力**
6. **AI連携**（タグ自動付与、要約）

---

## 5. 技術選定理由

### 5.1 Next.js を選んだ理由

#### メリット

- ✅ **フロント・バック統合**: 1つのリポジトリで完結
- ✅ **SSR/SSG対応**: SEO・初期表示速度の最適化
- ✅ **開発者人口が多い**: 採用・引き継ぎが容易
- ✅ **TypeScript標準サポート**: 型安全性の確保

#### デメリット（考慮点）

- ⚠️ バックエンドが複雑化した場合、切り出しが必要
- **対策**: 初期はAPI Routesで開発、必要に応じてマイクロサービス化

---

### 5.2 Supabase を選んだ理由

#### メリット

- ✅ **開発速度**: 認証・DB・Storageが一体化
- ✅ **PostgreSQL**: リレーショナルデータに最適
- ✅ **Realtime機能**: リアルタイム編集が標準搭載
- ✅ **オープンソース**: ベンダーロックインを回避可能

#### デメリット（考慮点）

- ⚠️ 規模拡大時のコスト
- **対策**: 初期はSupabaseで開発、将来的にAWS移行も可能

---

### 5.3 PostgreSQL を選んだ理由

#### メリット

- ✅ **リレーショナルデータの厳密な管理**: 会社 > 施設 > クラス > 子ども の階層構造
- ✅ **JSON型のサポート**: AI生成結果などの柔軟なデータ保存
- ✅ **トランザクション**: データ整合性の保証
- ✅ **拡張性**: インデックス、パーティショニングで大規模化に対応

#### NoSQLを選ばなかった理由

- ❌ 複雑なリレーションの管理が難しい
- ❌ トランザクションの保証が弱い
- ❌ データの整合性が重要な業務には不向き

---

### 5.4 TypeScript を選んだ理由

#### メリット

- ✅ **型安全性**: 施設ID・子どもIDの混同を防ぐ
- ✅ **開発効率**: IDEの補完・リファクタリングが強力
- ✅ **保守性**: コードの意図が明確になる
- ✅ **AI連携**: 入出力の型定義で安全性向上

---

## 6. データベース設計方針

### 6.1 命名規則の概要

詳細は `06_database_naming_rules.md` を参照。

#### テーブル接頭辞

|接頭辞|分類|例|
|---|---|---|
|`m_`|マスタ|`m_children`, `m_facilities`|
|`r_`|記録|`r_activity`, `r_observation`|
|`s_`|設定|`s_attendance_schedule`|
|`h_`|履歴・ログ|`h_login`, `h_attendance`|
|`_`|中間テーブル|`_user_facility`|
|`tmp_`|一時テーブル|`tmp_import_children`|

### 6.2 データベース設計の原則

#### 正規化 vs 非正規化

- **基本は正規化**（第3正規形まで）
- **パフォーマンス上必要な場合のみ非正規化**
    - 例: 記録数のカウントをマスタに持つ

#### リレーション設計

- **外部キー制約を必ず設定**（データ整合性の保証）
- **カスケード削除は慎重に**（論理削除を優先）

#### インデックス設計

- **検索条件に使うカラムにインデックス**
- **複合インデックスは順序に注意**
- **EXPLAIN ANALYZEで検証**

### 6.3 論理削除 vs 物理削除

#### 基本方針

- **マスタテーブル**: 論理削除（`deleted_at`）
- **記録テーブル**: 論理削除（後から参照する可能性）
- **ログテーブル**: 物理削除しない（保持期間のみ設定）

---

## 7. セキュリティ方針

### 7.1 認証・認可

- **認証**: Supabase Auth（メール・パスワード）
- **セッション管理**: JWT（有効期限: 8時間）
- **権限管理**: ロールベースアクセス制御（RBAC）
    - サイト管理者
    - 施設管理者
    - 一般職員

### 7.2 データ保護

- **個人情報の暗号化**: PostgreSQLのカラムレベル暗号化
- **通信の暗号化**: HTTPS必須
- **バックアップ**: 日次自動バックアップ（Supabase標準機能）

### 7.3 アクセス制御

- **Row Level Security（RLS）**: Supabaseで施設ごとのデータ分離
- **APIレート制限**: DDoS対策
- **SQLインジェクション対策**: パラメータ化クエリの徹底

---

## 8. スケーラビリティ

### 8.1 想定する規模

|項目|初期（1年目）|中期（3年目）|長期（5年目）|
|---|---|---|---|
|**施設数**|10施設|50施設|200施設|
|**子ども数**|500名|2,500名|10,000名|
|**職員数**|50名|250名|1,000名|
|**記録数/日**|100件|500件|2,000件|

### 8.2 スケーリング戦略

#### 垂直スケーリング（初期〜中期）

- Supabaseのプラン変更（CPU・メモリ増強）

#### 水平スケーリング（中期〜長期）

- **読み取りレプリカ**: 参照クエリの負荷分散
- **CDN**: 静的コンテンツの配信
- **キャッシュ**: Redis導入（頻繁にアクセスされるデータ）

#### マイクロサービス化（長期）

- API層をバックエンドサービスとして分離
- 認証サービス、記録サービス、レポートサービスに分割

---

## 9. 開発環境

### 9.1 開発ツール

|ツール|用途|
|---|---|
|**VS Code**|統合開発環境|
|**Git / GitHub**|バージョン管理|
|**Figma**|UI/UXデザイン|
|**draw.io / Miro**|ER図、フローチャート作成|

### 9.2 環境分離

|環境|用途|
|---|---|
|**開発環境（Local）**|個人開発|
|**検証環境（Staging）**|テスト・レビュー|
|**本番環境（Production）**|リリース|

---

## 10. 今後の拡張計画

### 10.1 Phase 4: 保護者向けポータル

- 保護者専用のログイン
- 自分の子どもの記録閲覧
- レポートのダウンロード

### 10.2 Phase 5: モバイルアプリ

- React Native による iOS/Android アプリ
- プッシュ通知機能

### 10.3 Phase 6: AI機能の強化

- 記録の自動要約
- タグの自動付与
- 成長予測・レコメンデーション

---

**作成日**: 2025年XX月XX日  
**最終更新**: 2025年XX月XX日  
**承認者**: プロジェクトリーダー
# ã®ã³ãƒ¬ã‚³ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¦‚è¦](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#1-%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E6%A6%82%E8%A6%81)
2. [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#2-%E6%8A%80%E8%A1%93%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF)
3. [ENUMå‹å®šç¾©](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#3-enum%E5%9E%8B%E5%AE%9A%E7%BE%A9)
4. [ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#4-%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB)
5. [è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#5-%E8%A8%98%E9%8C%B2%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB)
6. [è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#6-%E8%A8%AD%E5%AE%9A%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB)
7. [å±¥æ­´ãƒ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#7-%E5%B1%A5%E6%AD%B4%E3%83%AD%E3%82%B0%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB)
8. [ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#8-%E4%B8%AD%E9%96%93%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB)
9. [ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£å›³](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#9-%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E9%96%A2%E9%80%A3%E5%9B%B3)
10. [ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥](https://claude.ai/chat/a124b55d-b68a-4833-a41e-f455665f97a7#10-%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E6%88%A6%E7%95%A5)

---

## 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¦‚è¦

### 1.1 åŸºæœ¬æ–¹é‡

- **RDBMS**: PostgreSQLï¼ˆSupabaseï¼‰
- **å‘½åè¦å‰‡**: [06_database_naming_rules.md](https://claude.ai/chat/06_database_naming_rules.md) ã«æº–æ‹ 
- **èªè¨¼**: Supabase Auth ã‚’ä½¿ç”¨
- **è«–ç†å‰Šé™¤**: å…¨ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã« `deleted_at` ã‚«ãƒ©ãƒ ã‚’å®Ÿè£…

### 1.2 ãƒ†ãƒ¼ãƒ–ãƒ«åˆ†é¡

|æ¥é ­è¾|åˆ†é¡|èª¬æ˜|ãƒ†ãƒ¼ãƒ–ãƒ«æ•°|
|---|---|---|---|
|`m_`|ãƒã‚¹ã‚¿|ä¼šç¤¾ã€æ–½è¨­ã€è·å“¡ã€å­ã©ã‚‚ã€å­¦æ ¡ãªã©åŸºæœ¬ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£|7|
|`r_`|è¨˜éŒ²|æ—¥ã€…ã®æ¥­å‹™è¨˜éŒ²|4|
|`s_`|è¨­å®š|æ–½è¨­è¨­å®šã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ãªã©|3|
|`h_`|å±¥æ­´ãƒ»ãƒ­ã‚°|ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã€ç›£æŸ»ç”¨ãƒ‡ãƒ¼ã‚¿|1|
|`_`|ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«|å¤šå¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ç´ä»˜ã‘|4|

---

## 2. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### 2.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

- **PostgreSQL 15+**ï¼ˆSupabaseçµŒç”±ï¼‰
- **æ‹¡å¼µæ©Ÿèƒ½**:
    - `uuid-ossp`: UUIDç”Ÿæˆ
    - `pg_trgm`: æ—¥æœ¬èªå…¨æ–‡æ¤œç´¢

### 2.2 èªè¨¼

- **Supabase Auth**
    - `auth.users` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆSupabaseç®¡ç†ï¼‰
    - `m_users` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ¥­å‹™æƒ…å ±ï¼‰
    - ä¸¡è€…ã‚’ `id` ã§ç´ã¥ã‘

### 2.3 ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸

- **Supabase Storage**
    - å­ã©ã‚‚ã®é¡”å†™çœŸ
    - æ´»å‹•è¨˜éŒ²ã®å†™çœŸ
    - ãƒ¬ãƒãƒ¼ãƒˆPDF

### 2.4 PostgreSQLé–¢æ•°

#### å­¦å¹´è¨ˆç®—é–¢æ•°ï¼ˆ`calculate_grade`ï¼‰

```sql
CREATE OR REPLACE FUNCTION calculate_grade(birth_date DATE, grade_add INTEGER DEFAULT 0)
RETURNS INTEGER AS $$
BEGIN
  -- 4æœˆ1æ—¥åŸºæº–ã§å­¦å¹´è¨ˆç®—ï¼ˆå°å­¦æ ¡1å¹´ç”Ÿã‚’åŸºæº–ï¼‰
  RETURN CASE
    WHEN EXTRACT(MONTH FROM birth_date) >= 4 THEN
      -- 4æœˆä»¥é™ç”Ÿã¾ã‚Œï¼šç¾åœ¨å¹´ - ç”Ÿå¹´ - 6 + 1
      EXTRACT(YEAR FROM CURRENT_DATE) - EXTRACT(YEAR FROM birth_date) - 6 + 1
    ELSE
      -- 1-3æœˆç”Ÿã¾ã‚Œï¼šç¾åœ¨å¹´ - ç”Ÿå¹´ - 6
      EXTRACT(YEAR FROM CURRENT_DATE) - EXTRACT(YEAR FROM birth_date) - 6
  END + COALESCE(grade_add, 0);
END;
$$ LANGUAGE plpgsql;
```

**èª¬æ˜**:
- ç”Ÿå¹´æœˆæ—¥ã‹ã‚‰è‡ªå‹•çš„ã«ç¾åœ¨ã®å­¦å¹´ï¼ˆ1-6å¹´ç”Ÿï¼‰ã‚’è¨ˆç®—
- æ—¥æœ¬ã®å­¦æ ¡åˆ¶åº¦ã«æº–æ‹ ï¼ˆ4æœˆ1æ—¥åŸºæº–ï¼‰
- `grade_add`ã§ç•™å¹´ãƒ»é£›ã³ç´šãªã©ã®ç‰¹æ®Šã‚±ãƒ¼ã‚¹ã«å¯¾å¿œ
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®å­¦å¹´ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§ä½¿ç”¨

**ä½¿ç”¨ä¾‹**:
```sql
-- 2015å¹´5æœˆç”Ÿã¾ã‚Œã®å­ã©ã‚‚ã®å­¦å¹´ã‚’å–å¾—
SELECT calculate_grade('2015-05-01'::DATE, 0);  -- çµæœ: 4ï¼ˆ4å¹´ç”Ÿï¼‰

-- 2015å¹´2æœˆç”Ÿã¾ã‚Œã®å­ã©ã‚‚ã®å­¦å¹´ã‚’å–å¾—
SELECT calculate_grade('2015-02-01'::DATE, 0);  -- çµæœ: 5ï¼ˆ5å¹´ç”Ÿï¼‰

-- å­¦å¹´èª¿æ•´å€¤ã‚’ä½¿ç”¨ï¼ˆ+1å¹´ï¼‰
SELECT calculate_grade('2015-05-01'::DATE, 1);  -- çµæœ: 5ï¼ˆ5å¹´ç”Ÿï¼‰
```

#### JWT ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ é–¢æ•°ï¼ˆ`custom_access_token_hook`ï¼‰

```sql
CREATE OR REPLACE FUNCTION public.custom_access_token_hook(event jsonb)
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  user_claims jsonb;
  current_facility uuid;
BEGIN
  -- Get primary facility for the user
  SELECT facility_id INTO current_facility
  FROM _user_facility
  WHERE user_id = (event->>'user_id')::uuid
    AND is_current = true
    AND is_primary = true
  LIMIT 1;

  -- If no primary facility, get any current facility
  IF current_facility IS NULL THEN
    SELECT facility_id INTO current_facility
    FROM _user_facility
    WHERE user_id = (event->>'user_id')::uuid
      AND is_current = true
    LIMIT 1;
  END IF;

  -- Build custom claims from m_users table
  SELECT jsonb_build_object(
    'role', role,
    'company_id', company_id,
    'current_facility_id', current_facility
  ) INTO user_claims
  FROM m_users
  WHERE id = (event->>'user_id')::uuid
    AND is_active = true
    AND deleted_at IS NULL;

  -- If user not found or inactive, return event unchanged
  IF user_claims IS NULL THEN
    RETURN event;
  END IF;

  -- Add custom claims to app_metadata
  RETURN jsonb_set(
    event,
    '{claims, app_metadata}',
    COALESCE(event->'claims'->'app_metadata', '{}'::jsonb) || user_claims
  );
END;
$$;
```

**èª¬æ˜**:
- Supabase Auth ã®ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã€JWTãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’è¿½åŠ 
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® `role`, `company_id`, `current_facility_id` ã‚’ JWT ã® `app_metadata` ã«åŸ‹ã‚è¾¼ã¿
- APIå®Ÿè¡Œæ™‚ã®DBå•ã„åˆã‚ã›ã‚’å‰Šæ¸›ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šï¼ˆç´„40%ã®ã‚¯ã‚¨ãƒªå‰Šæ¸›ï¼‰
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: JWTã¯ç½²åã•ã‚Œã¦ã„ã‚‹ãŸã‚æ”¹ã–ã‚“ä¸å¯

**ä½¿ç”¨æ–¹æ³•**:
1. Supabase Dashboard > Database > Hooks ã§è¨­å®š
2. Event Type: "Custom Access Token"
3. Function: `public.custom_access_token_hook`

**APIå´ã§ã®ä½¿ç”¨ä¾‹**:
```typescript
import { getAuthenticatedUserMetadata } from '@/lib/auth/jwt';

const metadata = await getAuthenticatedUserMetadata();
// { role, company_id, current_facility_id } ãŒDBå•ã„åˆã‚ã›ãªã—ã§å–å¾—å¯èƒ½
```

**è©³ç´°**: `docs/jwt-custom-claims-setup.md` ã‚’å‚ç…§

#### è¦³å¯Ÿè¨˜éŒ²ã‚¿ã‚°æ›´æ–°é–¢æ•°ï¼ˆ`update_observation_tags`ï¼‰

```sql
CREATE OR REPLACE FUNCTION update_observation_tags(
  p_observation_id UUID,
  p_tag_ids TEXT[],
  p_is_auto_tagged BOOLEAN DEFAULT true
)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  -- Delete existing tags for this observation
  DELETE FROM _record_tag
  WHERE observation_id = p_observation_id;

  -- Insert new tags if any provided
  IF p_tag_ids IS NOT NULL AND array_length(p_tag_ids, 1) > 0 THEN
    INSERT INTO _record_tag (observation_id, tag_id, is_auto_tagged, confidence_score)
    SELECT
      p_observation_id,
      unnest(p_tag_ids)::uuid,  -- TEXTé…åˆ—ã‚’UUIDã«ã‚­ãƒ£ã‚¹ãƒˆ
      p_is_auto_tagged,
      NULL;
  END IF;

  -- If any error occurs, transaction will be automatically rolled back
EXCEPTION
  WHEN OTHERS THEN
    -- Re-raise the error with detailed context
    RAISE EXCEPTION 'Failed to update observation tags for observation_id %: %',
      p_observation_id, SQLERRM;
END;
$$;
```

**èª¬æ˜**:
- è¦³å¯Ÿè¨˜éŒ²ï¼ˆ`r_observation`ï¼‰ã®ã‚¿ã‚°ã‚’åŸå­çš„ï¼ˆã‚¢ãƒˆãƒŸãƒƒã‚¯ï¼‰ã«æ›´æ–°
- æ—¢å­˜ã®ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰æ–°ã—ã„ã‚¿ã‚°ã‚’æŒ¿å…¥ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œï¼‰
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯è‡ªå‹•çš„ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’ä¿è¨¼
- AIè§£æçµæœã®ã‚¿ã‚°æ›´æ–°æ™‚ã«ä½¿ç”¨

**é‡è¦: UUIDå‹ã‚­ãƒ£ã‚¹ãƒˆã«ã¤ã„ã¦**:
- `p_tag_ids` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ `TEXT[]` å‹ã§å—ã‘å–ã‚‹ï¼ˆSupabase RPCå‘¼ã³å‡ºã—ã®äº’æ›æ€§ã®ãŸã‚ï¼‰
- `_record_tag.tag_id` ã‚«ãƒ©ãƒ ã¯ `UUID` å‹
- `unnest(p_tag_ids)` ã¯ `TEXT` å‹ã‚’è¿”ã™ãŸã‚ã€æ˜ç¤ºçš„ã« `::uuid` ã‚­ãƒ£ã‚¹ãƒˆãŒå¿…è¦
- ã‚­ãƒ£ã‚¹ãƒˆãŒãªã„å ´åˆã€å‹ä¸ä¸€è‡´ã‚¨ãƒ©ãƒ¼ï¼ˆ`cannot automatically cast TEXT to UUID`ï¼‰ãŒç™ºç”Ÿã™ã‚‹

**ä½¿ç”¨ä¾‹**:
```sql
-- è¦³å¯Ÿè¨˜éŒ²ã«ã‚¿ã‚°ã€Œsocial_skillsã€ã€Œleadershipã€ã‚’è¿½åŠ 
SELECT update_observation_tags(
  'observation-uuid-here',
  ARRAY['social_skills', 'leadership'],
  true  -- AIè‡ªå‹•ã‚¿ã‚°ä»˜ã‘
);

-- ã‚¿ã‚°ã‚’å…¨ã¦å‰Šé™¤ï¼ˆç©ºé…åˆ—ã‚’æ¸¡ã™ï¼‰
SELECT update_observation_tags(
  'observation-uuid-here',
  ARRAY[]::TEXT[],
  true
);
```

**APIå´ã§ã®ä½¿ç”¨ä¾‹**:
```typescript
const { error } = await supabase.rpc('update_observation_tags', {
  p_observation_id: observationId,
  p_tag_ids: ['social_skills', 'leadership'],
  p_is_auto_tagged: true,
});
```

---

## 3. ENUMå‹å®šç¾©

### 3.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™

```sql
CREATE TYPE user_role AS ENUM (
  'site_admin',      -- ã‚µã‚¤ãƒˆç®¡ç†è€…ï¼ˆå…¨ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ï¼‰
  'company_admin',   -- ä¼šç¤¾çµŒå–¶è€…ï¼ˆè‡ªç¤¾ã®å…¨æ–½è¨­ç®¡ç†ï¼‰
  'facility_admin',  -- æ–½è¨­ç®¡ç†è€…ï¼ˆè‡ªæ–½è¨­ã®ã¿ç®¡ç†ï¼‰
  'staff'            -- ä¸€èˆ¬è·å“¡ï¼ˆè¨˜éŒ²å…¥åŠ›ã®ã¿ï¼‰
);
```

### 3.2 æ€§åˆ¥

```sql
CREATE TYPE gender_type AS ENUM (
  'male',
  'female',
  'other'
);
```

### 3.3 åœ¨ç±çŠ¶æ³

```sql
CREATE TYPE enrollment_status_type AS ENUM (
  'enrolled',   -- åœ¨ç±ä¸­
  'withdrawn'   -- é€€æ‰€
);
```

### 3.4 å¥‘ç´„å½¢æ…‹

```sql
CREATE TYPE enrollment_type AS ENUM (
  'regular',    -- é€šå¹´
  'temporary',  -- ä¸€æ™‚ï¼ˆé•·æœŸåˆ©ç”¨ï¼‰
  'spot'        -- ã‚¹ãƒãƒƒãƒˆ
);
```

### 3.5 å‡ºå¸­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

```sql
CREATE TYPE attendance_status_type AS ENUM (
  'scheduled',  -- äºˆå®šé€šã‚Šå‡ºå¸­
  'absent',     -- æ¬ å¸­
  'irregular'   -- ã‚¤ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼å‡ºå¸­
);
```

### 3.6 ãƒã‚§ãƒƒã‚¯æ–¹æ³•

```sql
CREATE TYPE check_method_type AS ENUM (
  'qr',      -- QRã‚³ãƒ¼ãƒ‰
  'manual'   -- æ‰‹å‹•
);
```

---

## 4. ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«

### 4.1 ä¼šç¤¾ãƒã‚¹ã‚¿ï¼ˆ`m_companies`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS m_companies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(200) NOT NULL,                    -- ä¼šç¤¾å
  name_kana VARCHAR(200),                        -- ä¼šç¤¾åã‚«ãƒŠ
  postal_code VARCHAR(10),                       -- éƒµä¾¿ç•ªå·
  address VARCHAR(500),                          -- ä½æ‰€
  phone VARCHAR(20),                             -- é›»è©±ç•ªå·
  email VARCHAR(255),                            -- ä»£è¡¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  is_active BOOLEAN NOT NULL DEFAULT true,       -- æœ‰åŠ¹/ç„¡åŠ¹
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_companies_is_active ON m_companies(is_active) WHERE deleted_at IS NULL;
```

---

### 4.2 æ–½è¨­ãƒã‚¹ã‚¿ï¼ˆ`m_facilities`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS m_facilities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID NOT NULL REFERENCES m_companies(id),  -- æ‰€å±ä¼šç¤¾
  name VARCHAR(200) NOT NULL,                           -- æ–½è¨­å
  name_kana VARCHAR(200),                               -- æ–½è¨­åã‚«ãƒŠ
  postal_code VARCHAR(10),                              -- éƒµä¾¿ç•ªå·
  address VARCHAR(500),                                 -- ä½æ‰€
  phone VARCHAR(20),                                    -- é›»è©±ç•ªå·
  email VARCHAR(255),                                   -- æ–½è¨­ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  capacity INTEGER,                                     -- å®šå“¡
  is_active BOOLEAN NOT NULL DEFAULT true,              -- æœ‰åŠ¹/ç„¡åŠ¹
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_facilities_company_id ON m_facilities(company_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_facilities_is_active ON m_facilities(is_active) WHERE deleted_at IS NULL;
```

---

### 4.3 ã‚¯ãƒ©ã‚¹ãƒã‚¹ã‚¿ï¼ˆ`m_classes`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS m_classes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  facility_id UUID NOT NULL REFERENCES m_facilities(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,                  -- ã‚¯ãƒ©ã‚¹åï¼ˆä¾‹: ã²ã¾ã‚ã‚Šçµ„ï¼‰
  age_group VARCHAR(50),                       -- å¯¾è±¡å¹´é½¢ï¼ˆä¾‹: 0æ­³å…ã€1-2æ­³å…ã€æ··åˆï¼‰
  capacity INTEGER,                            -- å®šå“¡
  room_number VARCHAR(20),                     -- éƒ¨å±‹ç•ªå·
  color_code VARCHAR(7),                       -- ã‚¯ãƒ©ã‚¹ã‚«ãƒ©ãƒ¼ï¼ˆHEX: #RRGGBBï¼‰
  display_order INTEGER,                       -- è¡¨ç¤ºé †åº
  is_active BOOLEAN NOT NULL DEFAULT true,     -- æœ‰åŠ¹/ç„¡åŠ¹
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_classes_facility_id ON m_classes(facility_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_classes_display_order ON m_classes(facility_id, display_order) WHERE deleted_at IS NULL;
```

---

### 4.4 ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¹ã‚¿ï¼ˆ`m_users`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS m_users (
  id UUID PRIMARY KEY,  -- auth.users.id ã¨åŒã˜å€¤ã‚’ä½¿ç”¨
  company_id UUID REFERENCES m_companies(id),  -- æ‰€å±ä¼šç¤¾ï¼ˆsite_adminã¯NULLï¼‰
  name VARCHAR(100) NOT NULL,                  -- æ°åï¼ˆæ¼¢å­—ï¼‰
  name_kana VARCHAR(100),                      -- æ°åï¼ˆã‚«ãƒŠï¼‰
  email VARCHAR(255) NOT NULL,                 -- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆauth.usersã¨åŒæœŸã€ä¸€æ„åˆ¶ç´„ãªã—ï¼‰
  phone VARCHAR(20),                           -- é›»è©±ç•ªå·
  hire_date DATE,                              -- å…¥ç¤¾æ—¥
  role user_role NOT NULL DEFAULT 'staff',     -- æ¨©é™
  is_active BOOLEAN NOT NULL DEFAULT true,     -- æœ‰åŠ¹/ç„¡åŠ¹
  is_retired BOOLEAN NOT NULL DEFAULT false,   -- é€€è·ãƒ•ãƒ©ã‚°
  retired_at TIMESTAMP WITH TIME ZONE,         -- é€€è·æ—¥
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_users_company_id ON m_users(company_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_role ON m_users(role) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_is_active ON m_users(is_active) WHERE deleted_at IS NULL;
```

**èªè¨¼ã¨ã®é€£æº**:

- `id` ã¯ Supabase Auth ã® `auth.users.id` ã¨åŒã˜å€¤
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã« `m_users` ã«ã‚‚åŒæ™‚ç™»éŒ²

---

### 4.5 å­ã©ã‚‚ãƒã‚¹ã‚¿ï¼ˆ`m_children`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS m_children (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  facility_id UUID NOT NULL REFERENCES m_facilities(id),  -- æ‰€å±æ–½è¨­
  school_id UUID REFERENCES m_schools(id),       -- æ‰€å±å­¦æ ¡ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨ï¼‰

  -- åŸºæœ¬æƒ…å ±
  family_name VARCHAR(50) NOT NULL,              -- å§“ï¼ˆæ¼¢å­—ï¼‰
  given_name VARCHAR(50) NOT NULL,               -- åï¼ˆæ¼¢å­—ï¼‰
  family_name_kana VARCHAR(50),                  -- å§“ï¼ˆã‚«ãƒŠï¼‰
  given_name_kana VARCHAR(50),                   -- åï¼ˆã‚«ãƒŠï¼‰
  nickname VARCHAR(50),                          -- å‘¼ã³åãƒ»ç•¥ç§°
  gender gender_type,                            -- æ€§åˆ¥
  birth_date DATE NOT NULL,                      -- ç”Ÿå¹´æœˆæ—¥
  grade_add INTEGER DEFAULT 0,                   -- å­¦å¹´èª¿æ•´å€¤ï¼ˆÂ±2å¹´ç¨‹åº¦ã€ç•™å¹´ãƒ»é£›ã³ç´šå¯¾å¿œï¼‰
  
  -- å†™çœŸãƒ»ç”»åƒ
  photo_url TEXT,                                -- é¡”å†™çœŸURLï¼ˆSupabase Storageï¼‰
  photo_permission_public BOOLEAN DEFAULT false, -- å¤–éƒ¨å…¬é–‹OK
  photo_permission_share BOOLEAN DEFAULT false,  -- ä»–ã®ä¿è­·è€…ã«å…±æœ‰OK
  
  -- ä¿è­·è€…æƒ…å ±ï¼ˆDEPRECATED: m_guardians + _child_guardian ã‚’ä½¿ç”¨ï¼‰
  -- âš ï¸ 2026å¹´1æœˆç§»è¡Œæ¸ˆã¿ã€‚ä»Šå¾Œã¯ m_guardians + _child_guardian ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚
  parent_name VARCHAR(100),                      -- ä¿è­·è€…åï¼ˆéæ¨å¥¨ãƒ»èª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
  parent_email VARCHAR(255),                     -- ä¿è­·è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆéæ¨å¥¨ãƒ»èª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
  parent_phone VARCHAR(20),                      -- ä¿è­·è€…é›»è©±ç•ªå·ï¼ˆéæ¨å¥¨ãƒ»èª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
  emergency_contact_name VARCHAR(100),           -- ç·Šæ€¥é€£çµ¡å…ˆåï¼ˆéæ¨å¥¨ãƒ»èª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
  emergency_contact_phone VARCHAR(20),           -- ç·Šæ€¥é€£çµ¡å…ˆé›»è©±ç•ªå·ï¼ˆéæ¨å¥¨ãƒ»èª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
  sibling_id UUID REFERENCES m_children(id),     -- å…„å¼Ÿå§‰å¦¹ã®ç´ã¥ã‘ï¼ˆDEPRECATED: _child_sibling ã‚’ä½¿ç”¨ï¼‰
  
  -- ãƒ¬ãƒãƒ¼ãƒˆè¨­å®š
  report_name_permission BOOLEAN DEFAULT true,   -- ãƒ¬ãƒãƒ¼ãƒˆã«åå‰è¡¨ç¤ºOK
  
  -- å¥åº·ãƒ»ç‰¹æ€§æƒ…å ±
  allergies TEXT,                                -- ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±
  health_notes TEXT,                             -- å¥åº·ã«é–¢ã™ã‚‹ç‰¹è¨˜äº‹é …
  special_needs TEXT,                            -- ç‰¹åˆ¥ãªæ”¯æ´ãŒå¿…è¦ãªå ´åˆã®è©³ç´°
  child_characteristics TEXT,                    -- å­ã©ã‚‚ã®åŸºæœ¬ç‰¹æ€§
  parent_characteristics TEXT,                   -- è¦ªã®ç‰¹æ€§ãƒ»è¦æœ›
  
  -- åœ¨ç±æƒ…å ±
  enrollment_status enrollment_status_type NOT NULL DEFAULT 'enrolled',
  enrollment_type enrollment_type NOT NULL DEFAULT 'regular',
  enrolled_at TIMESTAMP WITH TIME ZONE,          -- å…¥æ‰€æ—¥
  withdrawn_at TIMESTAMP WITH TIME ZONE,         -- é€€æ‰€æ—¥
  
  -- å…±é€šã‚«ãƒ©ãƒ 
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_children_facility_id ON m_children(facility_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_children_enrollment_status ON m_children(enrollment_status) WHERE deleted_at IS NULL;
CREATE INDEX idx_children_birth_date ON m_children(birth_date);
CREATE INDEX idx_children_sibling_id ON m_children(sibling_id) WHERE sibling_id IS NOT NULL;

-- å­¦æ ¡ãƒ»å­¦å¹´ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_children_school_id ON m_children(school_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_children_birth_grade_add ON m_children(birth_date, grade_add) WHERE deleted_at IS NULL;

-- ãƒ•ãƒ«ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆåå‰æ¤œç´¢ï¼‰
CREATE INDEX idx_children_name_search ON m_children
  USING gin(to_tsvector('japanese', family_name || ' ' || given_name || ' ' || COALESCE(nickname, '')));
```

---

### 4.6 è¦³ç‚¹ã‚¿ã‚°ãƒã‚¹ã‚¿ï¼ˆ`m_observation_tags`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS m_observation_tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(50) NOT NULL UNIQUE,              -- ã‚¿ã‚°åï¼ˆä¾‹: è‡ªç«‹ã€ç¤¾ä¼šæ€§ï¼‰
  name_en VARCHAR(50),                           -- è‹±èªåï¼ˆå°†æ¥ã®å›½éš›å±•é–‹ç”¨ï¼‰
  description TEXT,                              -- èª¬æ˜
  color VARCHAR(7),                              -- è¡¨ç¤ºè‰²ï¼ˆHEX: #FF5733ï¼‰
  sort_order INTEGER NOT NULL DEFAULT 0,         -- è¡¨ç¤ºé †åº
  is_active BOOLEAN NOT NULL DEFAULT true,       -- æœ‰åŠ¹/ç„¡åŠ¹
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_observation_tags_is_active ON m_observation_tags(is_active) WHERE deleted_at IS NULL;
CREATE INDEX idx_observation_tags_sort_order ON m_observation_tags(sort_order);
```

**åˆæœŸãƒ‡ãƒ¼ã‚¿**:

```sql
INSERT INTO m_observation_tags (name, name_en, description, color, sort_order) VALUES
  ('è‡ªç«‹', 'Independence', 'è‡ªåˆ†ã§ã§ãã‚‹ã“ã¨ãŒå¢—ãˆã‚‹', '#4CAF50', 1),
  ('ç¤¾ä¼šæ€§', 'Sociability', 'å‹é”ã¨é–¢ã‚ã‚‹åŠ›', '#2196F3', 2),
  ('æ„Ÿæƒ…ã®å®‰å®š', 'Emotional Stability', 'æ°—æŒã¡ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«', '#FF9800', 3),
  ('å¥½å¥‡å¿ƒ', 'Curiosity', 'æ–°ã—ã„ã“ã¨ã¸ã®èˆˆå‘³', '#9C27B0', 4),
  ('è¡¨ç¾åŠ›', 'Expressiveness', 'è¨€è‘‰ã‚„èº«ä½“ã§ä¼ãˆã‚‹åŠ›', '#E91E63', 5);
```

---

### 4.7 ä¿è­·è€…ãƒã‚¹ã‚¿ï¼ˆ`m_guardians`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS m_guardians (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  facility_id UUID NOT NULL REFERENCES m_facilities(id),

  -- åŸºæœ¬æƒ…å ±ï¼ˆæš—å·åŒ–ï¼‰
  family_name TEXT NOT NULL,                     -- å§“ï¼ˆæ¼¢å­—ï¼‰ï¼ˆAES-256-GCMæš—å·åŒ–ã€Base64urlï¼‰
  given_name TEXT NOT NULL DEFAULT '',           -- åï¼ˆæ¼¢å­—ï¼‰ï¼ˆAES-256-GCMæš—å·åŒ–ã€Base64urlï¼‰
  family_name_kana TEXT,                         -- å§“ï¼ˆã‚«ãƒŠï¼‰ï¼ˆAES-256-GCMæš—å·åŒ–ã€Base64urlï¼‰
  given_name_kana TEXT,                          -- åï¼ˆã‚«ãƒŠï¼‰ï¼ˆAES-256-GCMæš—å·åŒ–ã€Base64urlï¼‰

  -- é€£çµ¡å…ˆï¼ˆæš—å·åŒ–ï¼‰
  phone TEXT,                                    -- é›»è©±ç•ªå·ï¼ˆAES-256-GCMæš—å·åŒ–ã€Base64urlï¼‰
  email TEXT,                                    -- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆAES-256-GCMæš—å·åŒ–ã€Base64urlï¼‰
  postal_code VARCHAR(10),                       -- éƒµä¾¿ç•ªå·
  address TEXT,                                  -- ä½æ‰€

  -- å‚™è€ƒ
  notes TEXT,                                    -- ç‰¹è¨˜äº‹é …

  -- å…±é€šã‚«ãƒ©ãƒ 
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_guardians_facility_id ON m_guardians(facility_id) WHERE deleted_at IS NULL;
-- æ³¨æ„: phone, email ã¯æš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯æ¤œç´¢ã«ä½¿ç”¨ä¸å¯
-- æ¤œç´¢ã«ã¯ s_pii_search_index ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒãƒƒã‚·ãƒ¥ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨

-- ãƒ•ãƒ«ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆåå‰æ¤œç´¢ï¼‰
-- given_name ã¯ä½¿ç”¨ã—ãªã„ãŸã‚ã€family_name ã®ã¿ã§æ¤œç´¢
CREATE INDEX idx_guardians_name_search ON m_guardians
  USING gin(to_tsvector('japanese', family_name));
```

### ä¿è­·è€…æƒ…å ±ã®ç®¡ç†æ–¹é‡ï¼ˆ2026å¹´1æœˆæ›´æ–°ï¼‰

**æ°åã®æ ¼ç´æ–¹æ³•**:
- `family_name`: ã€Œä½è—¤ å¤ªéƒã€ï¼ˆå§“åã¾ã¨ã‚ã¦æ ¼ç´ï¼‰
- `given_name`: '' ï¼ˆç©ºæ–‡å­—åˆ—ã€ã‚¹ã‚­ãƒ¼ãƒäº’æ›æ€§ã®ãŸã‚ä¿æŒï¼‰
- `family_name_kana`, `given_name_kana`: ç©ºæ–‡å­—åˆ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**ç·Šæ€¥é€£çµ¡å…ˆã®ç®¡ç†**:
- ä¸»ãŸã‚‹ä¿è­·è€…: `is_primary = true`ï¼ˆ`_child_guardian`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- ç·Šæ€¥é€£çµ¡å…ˆï¼ˆç¥–çˆ¶æ¯ç­‰ï¼‰: `is_emergency_contact = true`ï¼ˆ`_child_guardian`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- 1äººã®å…ç«¥ã«è¤‡æ•°ã®ä¿è­·è€…ã‚’ç´ã¥ã‘å¯èƒ½

**ç§»è¡Œæ–¹é‡**:
- `m_children`ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¿è­·è€…é–¢é€£ã‚«ãƒ©ãƒ ï¼ˆ`parent_name`, `parent_email`, `parent_phone`, `emergency_contact_name`, `emergency_contact_phone`ï¼‰ã¯éæ¨å¥¨ï¼ˆ2026å¹´1æœˆç§»è¡Œæ¸ˆã¿ï¼‰
- æ–°è¦ç™»éŒ²ãƒ»æ›´æ–°ã¯å¿…ãš`m_guardians` + `_child_guardian`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨

---

## 5. è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«

### 5.1 æ´»å‹•è¨˜éŒ²ï¼ˆ`r_activity`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS r_activity (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  facility_id UUID NOT NULL REFERENCES m_facilities(id),
  class_id UUID REFERENCES m_classes(id),        -- ã‚¯ãƒ©ã‚¹å˜ä½ã®æ´»å‹•ã®å ´åˆ

  -- è¨˜éŒ²æ—¥æ™‚
  activity_date DATE NOT NULL,                   -- æ´»å‹•æ—¥ï¼ˆä»Šæ—¥ã®æ—¥ä»˜ï¼‰

  -- æ´»å‹•å†…å®¹
  title VARCHAR(200),                            -- ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹: å…¬åœ’ã§å¤–éŠã³ï¼‰
  content TEXT NOT NULL,                         -- æ´»å‹•å†…å®¹ï¼ˆæœ¬æ–‡ï¼‰
  snack TEXT,                                    -- ãŠã‚„ã¤
  mentioned_children TEXT[],                     -- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸå­ä¾›ã®æš—å·åŒ–ãƒˆãƒ¼ã‚¯ãƒ³ã®é…åˆ—

  -- å†™çœŸï¼ˆJSONBã§è¤‡æ•°æšä¿å­˜ï¼‰
  photos JSONB,                                  -- [{url: "...", caption: "..."}, ...]

  -- ã‚¤ãƒ™ãƒ³ãƒˆãƒ»æ—¥ç¨‹æƒ…å ±
  event_name TEXT,                               -- ä»Šæ—¥ã®è¡Œäº‹ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå
  daily_schedule JSONB,                          -- 1æ—¥ã®æµã‚Œï¼ˆJSONBã‚¹ã‚­ãƒ¼ãƒå‚ç…§ï¼‰
  role_assignments JSONB,                        -- å½¹å‰²åˆ†æ‹…ï¼ˆJSONBã‚¹ã‚­ãƒ¼ãƒå‚ç…§ï¼‰
  special_notes TEXT,                            -- ç‰¹è¨˜äº‹é …ï¼ˆå…¨ä½“ã‚’é€šã—ã¦ã®å‡ºæ¥äº‹ï¼‰
  meal JSONB,                                    -- ã”ã¯ã‚“æƒ…å ±ï¼ˆJSONBã‚¹ã‚­ãƒ¼ãƒå‚ç…§ï¼‰

  -- è¨˜éŒ²è€…æƒ…å ±
  created_by UUID NOT NULL REFERENCES m_users(id),
  updated_by UUID REFERENCES m_users(id),

  -- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç·¨é›†ç”¨
  last_edited_by UUID REFERENCES m_users(id),    -- æœ€å¾Œã«ç·¨é›†ã—ãŸäºº
  last_edited_at TIMESTAMP WITH TIME ZONE,       -- æœ€å¾Œã®ç·¨é›†æ—¥æ™‚

  -- å…±é€šã‚«ãƒ©ãƒ 
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_activity_facility_id ON r_activity(facility_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_activity_class_id ON r_activity(class_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_activity_date ON r_activity(activity_date) WHERE deleted_at IS NULL;
CREATE INDEX idx_activity_created_by ON r_activity(created_by);
CREATE INDEX idx_activity_facility_date ON r_activity(facility_id, activity_date) WHERE deleted_at IS NULL;
CREATE INDEX idx_activity_mentioned_children ON r_activity USING GIN (mentioned_children);
```

**JSONBã‚«ãƒ©ãƒ ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©**:

| ã‚«ãƒ©ãƒ  | ã‚¹ã‚­ãƒ¼ãƒ | èª¬æ˜ |
|--------|----------|------|
| `daily_schedule` | `[{time: string, content: string}, ...]` | 1æ—¥ã®æµã‚Œã‚’æ™‚åˆ»é †ã«è¨˜éŒ² |
| `role_assignments` | `[{user_id: string, user_name: string, role: string}, ...]` | è·å“¡ã®å½¹å‰²åˆ†æ‹… |
| `meal` | `{menu: string, items_to_bring: string, notes: string}` | ã”ã¯ã‚“æƒ…å ± |

**daily_schedule ã®ä¾‹**:
```json
[
  {"time": "09:00", "content": "æœã®ä¼š"},
  {"time": "10:00", "content": "å¤–éŠã³"},
  {"time": "12:00", "content": "æ˜¼é£Ÿ"},
  {"time": "14:00", "content": "ãŠã‚„ã¤"},
  {"time": "15:00", "content": "è‡ªç”±æ™‚é–“"}
]
```

**role_assignments ã®ä¾‹**:
```json
[
  {"user_id": "uuid-1", "user_name": "ç”°ä¸­", "role": "é…è†³"},
  {"user_id": "uuid-2", "user_name": "ä½è—¤", "role": "è¦‹å®ˆã‚Š"},
  {"user_id": "uuid-3", "user_name": "å±±ç”°", "role": "ç‰‡ä»˜ã‘"}
]
```

**meal ã®ä¾‹**:
```json
{
  "menu": "ã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹",
  "items_to_bring": "ãŠç®¸ã€ã‚¹ãƒ—ãƒ¼ãƒ³",
  "notes": "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼å¯¾å¿œé£Ÿã‚ã‚Š"
}
```

---

### 5.2 å­ã©ã‚‚è¦³å¯Ÿè¨˜éŒ²ï¼ˆ`r_observation`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS r_observation (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  child_id UUID NOT NULL REFERENCES m_children(id),
  activity_id UUID REFERENCES r_activity(id),    -- å…ƒã«ãªã£ãŸæ´»å‹•è¨˜éŒ²ï¼ˆã‚ã‚‹å ´åˆï¼‰
  
  -- è¨˜éŒ²æ—¥æ™‚
  observation_date DATE NOT NULL,                -- è¦³å¯Ÿæ—¥
  
  -- è¦³å¯Ÿå†…å®¹
  content TEXT NOT NULL,                         -- è¦³å¯Ÿå†…å®¹ï¼ˆæœ¬æ–‡ï¼‰
  is_fact BOOLEAN DEFAULT true,                  -- äº‹å®Ÿã‹æ‰€æ„Ÿã‹ï¼ˆAIã§åˆ¤å®šï¼‰
  
  -- AIè§£æçµæœ
  objective TEXT,                                -- AIè§£æã§åˆ†é›¢ã•ã‚ŒãŸå®¢è¦³/äº‹å®Ÿéƒ¨åˆ†
  subjective TEXT,                               -- AIè§£æã§åˆ†é›¢ã•ã‚ŒãŸä¸»è¦³/æ‰€æ„Ÿéƒ¨åˆ†
  ai_analyzed_at TIMESTAMP WITH TIME ZONE,      -- AIè§£æå®Ÿè¡Œæ—¥æ™‚
  is_ai_analyzed BOOLEAN DEFAULT false,          -- AIè§£æãŒå®Ÿè¡Œã•ã‚ŒãŸã‹ã©ã†ã‹
  
  -- å†™çœŸ
  photos JSONB,                                  -- [{url: "...", caption: "..."}, ...]
  
  -- è¨˜éŒ²è€…æƒ…å ±
  created_by UUID NOT NULL REFERENCES m_users(id),
  updated_by UUID REFERENCES m_users(id),
  
  -- å…±é€šã‚«ãƒ©ãƒ 
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_observation_child_id ON r_observation(child_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_observation_activity_id ON r_observation(activity_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_observation_date ON r_observation(observation_date) WHERE deleted_at IS NULL;
CREATE INDEX idx_observation_created_by ON r_observation(created_by);
CREATE INDEX idx_observation_child_date ON r_observation(child_id, observation_date) WHERE deleted_at IS NULL;
```

---

### 5.3 å­ã©ã‚‚ã®å£°è¨˜éŒ²ï¼ˆ`r_voice`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS r_voice (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  child_id UUID NOT NULL REFERENCES m_children(id),
  
  -- è¨˜éŒ²æ—¥æ™‚
  voice_date DATE NOT NULL,                      -- è¨˜éŒ²æ—¥
  
  -- å­ã©ã‚‚ã®å£°
  content TEXT NOT NULL,                         -- å­ã©ã‚‚ãŒè¨€ã£ãŸã“ã¨ãƒ»æ„è¦‹
  context TEXT,                                  -- ã©ã‚“ãªå ´é¢ã§ã®ç™ºè¨€ã‹
  
  -- è¨˜éŒ²è€…æƒ…å ±
  created_by UUID NOT NULL REFERENCES m_users(id),
  
  -- å…±é€šã‚«ãƒ©ãƒ 
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_voice_child_id ON r_voice(child_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_voice_date ON r_voice(voice_date) WHERE deleted_at IS NULL;
CREATE INDEX idx_voice_child_date ON r_voice(child_id, voice_date) WHERE deleted_at IS NULL;
```

---

### 5.4 æ—¥æ¬¡å‡ºå¸­äºˆå®šï¼ˆ`r_daily_attendance`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS r_daily_attendance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  facility_id UUID NOT NULL REFERENCES m_facilities(id),
  child_id UUID NOT NULL REFERENCES m_children(id),
  
  -- å‡ºå¸­äºˆå®šæ—¥
  attendance_date DATE NOT NULL,
  
  -- å‡ºå¸­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status attendance_status_type NOT NULL DEFAULT 'scheduled',
  
  -- å‚™è€ƒï¼ˆæ¬ å¸­ç†ç”±ãªã©ï¼‰
  note TEXT,
  
  -- ç™»éŒ²è€…
  created_by UUID NOT NULL REFERENCES m_users(id),
  updated_by UUID REFERENCES m_users(id),
  
  -- å…±é€šã‚«ãƒ©ãƒ 
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  UNIQUE(child_id, attendance_date)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_daily_attendance_facility_date ON r_daily_attendance(facility_id, attendance_date);
CREATE INDEX idx_daily_attendance_child_id ON r_daily_attendance(child_id);
CREATE INDEX idx_daily_attendance_date ON r_daily_attendance(attendance_date);
CREATE INDEX idx_daily_attendance_status ON r_daily_attendance(status);
```

---

## 6. è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«

### 6.1 æ›œæ—¥é€šæ‰€è¨­å®šï¼ˆ`s_attendance_schedule`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS s_attendance_schedule (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  child_id UUID NOT NULL REFERENCES m_children(id) ON DELETE CASCADE,
  
  -- æ›œæ—¥åˆ¥ã®é€šæ‰€è¨­å®šï¼ˆtrue = ãã®æ›œæ—¥ã«æ¥ã‚‹ï¼‰
  monday BOOLEAN NOT NULL DEFAULT false,
  tuesday BOOLEAN NOT NULL DEFAULT false,
  wednesday BOOLEAN NOT NULL DEFAULT false,
  thursday BOOLEAN NOT NULL DEFAULT false,
  friday BOOLEAN NOT NULL DEFAULT false,
  saturday BOOLEAN NOT NULL DEFAULT false,
  sunday BOOLEAN NOT NULL DEFAULT false,
  
  -- æœ‰åŠ¹æœŸé–“
  valid_from DATE NOT NULL,                      -- è¨­å®šé–‹å§‹æ—¥
  valid_to DATE,                                 -- è¨­å®šçµ‚äº†æ—¥ï¼ˆNULL = ç„¡æœŸé™ï¼‰
  
  is_active BOOLEAN NOT NULL DEFAULT true,       -- æœ‰åŠ¹/ç„¡åŠ¹
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_attendance_schedule_child_id ON s_attendance_schedule(child_id);
CREATE INDEX idx_attendance_schedule_valid_from ON s_attendance_schedule(valid_from);
CREATE INDEX idx_attendance_schedule_is_active ON s_attendance_schedule(is_active) WHERE is_active = true;
```

---

### 6.2 å­¦æ ¡ãƒã‚¹ã‚¿ï¼ˆ`m_schools`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS m_schools (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  facility_id UUID NOT NULL REFERENCES m_facilities(id),

  -- åŸºæœ¬æƒ…å ±
  name VARCHAR(200) NOT NULL,                      -- å­¦æ ¡åï¼ˆä¾‹: ç¬¬ä¸€å°å­¦æ ¡ï¼‰
  name_kana VARCHAR(200),                          -- å­¦æ ¡åã‚«ãƒŠ
  postal_code VARCHAR(10),                         -- éƒµä¾¿ç•ªå·
  address VARCHAR(500),                            -- ä½æ‰€
  phone VARCHAR(20),                               -- é›»è©±ç•ªå·

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  is_active BOOLEAN NOT NULL DEFAULT true,         -- æœ‰åŠ¹/ç„¡åŠ¹

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_m_schools_facility
  ON m_schools(facility_id)
  WHERE deleted_at IS NULL;

CREATE INDEX idx_m_schools_name
  ON m_schools(name)
  WHERE deleted_at IS NULL;
```

**èª¬æ˜**:
- å­¦ç«¥ä¿è‚²æ–½è¨­ãŒé€£æºã™ã‚‹å°å­¦æ ¡ã‚’ç®¡ç†
- 1æ–½è¨­ã«è¤‡æ•°ã®å­¦æ ¡ãŒç´ã¥ãå¯èƒ½æ€§ãŒã‚ã‚‹
- å­¦æ ¡ã”ã¨ã«ç™»æ ¡æ™‚åˆ»ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®š

---

### 6.3 å­¦æ ¡ç™»æ ¡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ`s_school_schedules`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS s_school_schedules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  school_id UUID NOT NULL REFERENCES m_schools(id) ON DELETE CASCADE,

  -- å¯¾è±¡å­¦å¹´ï¼ˆè¤‡æ•°é¸æŠå¯èƒ½ã€é…åˆ—å½¢å¼ï¼‰
  grades TEXT[] NOT NULL,  -- ä¾‹: ['1', '2', '3'] â†’ 1~3å¹´ç”Ÿ

  -- æ›œæ—¥åˆ¥ç™»æ ¡æ™‚åˆ»
  monday_time TIME,                                -- æœˆæ›œæ—¥ã®ç™»æ ¡æ™‚åˆ»
  tuesday_time TIME,                               -- ç«æ›œæ—¥ã®ç™»æ ¡æ™‚åˆ»
  wednesday_time TIME,                             -- æ°´æ›œæ—¥ã®ç™»æ ¡æ™‚åˆ»
  thursday_time TIME,                              -- æœ¨æ›œæ—¥ã®ç™»æ ¡æ™‚åˆ»
  friday_time TIME,                                -- é‡‘æ›œæ—¥ã®ç™»æ ¡æ™‚åˆ»
  saturday_time TIME,                              -- åœŸæ›œæ—¥ã®ç™»æ ¡æ™‚åˆ»ï¼ˆé€šå¸¸NULLï¼‰
  sunday_time TIME,                                -- æ—¥æ›œæ—¥ã®ç™»æ ¡æ™‚åˆ»ï¼ˆé€šå¸¸NULLï¼‰

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_s_school_schedules_school
  ON s_school_schedules(school_id)
  WHERE deleted_at IS NULL;

-- å­¦å¹´é…åˆ—ã®æ¤œç´¢ç”¨GINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_s_school_schedules_grades
  ON s_school_schedules USING gin(grades)
  WHERE deleted_at IS NULL;
```

**èª¬æ˜**:
- å­¦æ ¡ã”ã¨ãƒ»å­¦å¹´ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã®ç™»æ ¡æ™‚åˆ»ãƒ‘ã‚¿ãƒ¼ãƒ³
- ä¾‹: ã€Œ1~2å¹´ç”Ÿã¯æœˆ~é‡‘ 08:00ç™»æ ¡ã€ã€Œ3~6å¹´ç”Ÿã¯æœˆ~é‡‘ 08:00ç™»æ ¡ã€
- æ›œæ—¥ã”ã¨ã«ç•°ãªã‚‹æ™‚åˆ»ã‚’è¨­å®šå¯èƒ½ï¼ˆçŸ­ç¸®æˆæ¥­ãªã©ï¼‰
- æ™‚åˆ»ãŒNULLã®æ›œæ—¥ã¯ã€Œç™»æ ¡ãªã—ã€ã‚’æ„å‘³ã™ã‚‹

---

### 6.4 PIIæ¤œç´¢ç”¨ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ`s_pii_search_index`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS s_pii_search_index (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æƒ…å ±
  entity_type VARCHAR(20) NOT NULL,  -- 'child' or 'guardian'
  entity_id UUID NOT NULL,            -- m_children.id or m_guardians.id
  
  -- æ¤œç´¢ã‚¿ã‚¤ãƒ—
  search_type VARCHAR(20) NOT NULL,   -- 'phone', 'email', 'name', 'name_kana'
  
  -- æ¤œç´¢ç”¨ãƒ‡ãƒ¼ã‚¿
  search_hash VARCHAR(64),            -- SHA-256ãƒãƒƒã‚·ãƒ¥ï¼ˆé›»è©±ç•ªå·ãƒ»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç”¨ã€64æ–‡å­—ï¼‰
  normalized_value TEXT,              -- æ­£è¦åŒ–ã•ã‚ŒãŸå€¤ï¼ˆåå‰ã®éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ç”¨ï¼‰
  
  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- åˆ¶ç´„
  CONSTRAINT unique_entity_search UNIQUE(entity_type, entity_id, search_type),
  
  -- ãƒã‚§ãƒƒã‚¯åˆ¶ç´„: search_hash ã¨ normalized_value ã®ã©ã¡ã‚‰ã‹ã¯å¿…é ˆ
  CONSTRAINT check_search_data CHECK (
    (search_hash IS NOT NULL) OR (normalized_value IS NOT NULL)
  )
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
-- 1. é›»è©±ç•ªå·ãƒ»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å®Œå…¨ä¸€è‡´æ¤œç´¢ç”¨ï¼ˆsearch_hashï¼‰
CREATE INDEX idx_pii_search_hash 
  ON s_pii_search_index(search_hash) 
  WHERE search_hash IS NOT NULL;

-- 2. åå‰ã®éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ç”¨ï¼ˆnormalized_valueã€GINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§æ—¥æœ¬èªæ¤œç´¢ã‚’é«˜é€ŸåŒ–ï¼‰
CREATE INDEX idx_pii_search_normalized_value 
  ON s_pii_search_index USING gin(to_tsvector('japanese', normalized_value))
  WHERE normalized_value IS NOT NULL;

-- 3. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‰Šé™¤æ™‚ã®æ¤œç´¢ç”¨ï¼ˆentity_type, entity_idï¼‰
CREATE INDEX idx_pii_search_entity 
  ON s_pii_search_index(entity_type, entity_id);

-- 4. æ¤œç´¢ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šç”¨ï¼ˆentity_type, search_type, search_hashï¼‰
CREATE INDEX idx_pii_search_type_hash 
  ON s_pii_search_index(entity_type, search_type, search_hash)
  WHERE search_hash IS NOT NULL;

-- 5. åå‰æ¤œç´¢ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šç”¨ï¼ˆentity_type, search_type, normalized_valueï¼‰
CREATE INDEX idx_pii_search_type_normalized 
  ON s_pii_search_index(entity_type, search_type, normalized_value)
  WHERE normalized_value IS NOT NULL;
```

**èª¬æ˜**:
- æš—å·åŒ–ã•ã‚ŒãŸPIIãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œç´¢ã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«
- **é›»è©±ç•ªå·ãƒ»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**: `search_hash`ï¼ˆSHA-256ãƒãƒƒã‚·ãƒ¥ï¼‰ã§å®Œå…¨ä¸€è‡´æ¤œç´¢
- **åå‰ãƒ»ãƒ•ãƒªã‚¬ãƒŠ**: `normalized_value`ï¼ˆæ­£è¦åŒ–ã•ã‚ŒãŸå€¤ï¼‰ã§éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ï¼ˆ`ilike`ï¼‰
- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆå…ç«¥ãƒ»ä¿è­·è€…ï¼‰ã®ä¿å­˜ãƒ»æ›´æ–°æ™‚ã«è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹
- æ¤œç´¢æ™‚ã¯ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰`entity_id`ã‚’å–å¾—ã—ã€æœ¬ä½“ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰è©³ç´°æƒ…å ±ã‚’å–å¾—

**ä½¿ç”¨ä¾‹**:
```sql
-- é›»è©±ç•ªå·ã§ä¿è­·è€…ã‚’æ¤œç´¢
SELECT entity_id FROM s_pii_search_index
WHERE entity_type = 'guardian'
  AND search_type = 'phone'
  AND search_hash = 'abc123...'  -- æ­£è¦åŒ–ã•ã‚ŒãŸé›»è©±ç•ªå·ã®SHA-256ãƒãƒƒã‚·ãƒ¥
LIMIT 1;

-- åå‰ã§å…ç«¥ã‚’éƒ¨åˆ†ä¸€è‡´æ¤œç´¢
SELECT entity_id FROM s_pii_search_index
WHERE entity_type = 'child'
  AND search_type = 'name'
  AND normalized_value ILIKE '%ç”°ä¸­%';
```

---

## 7. å±¥æ­´ãƒ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«

### 7.1 å‡ºæ¬ å®Ÿç¸¾ãƒ­ã‚°ï¼ˆ`h_attendance`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS h_attendance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  child_id UUID NOT NULL REFERENCES m_children(id),
  facility_id UUID NOT NULL REFERENCES m_facilities(id),
  
  -- ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æƒ…å ±
  checked_in_at TIMESTAMP WITH TIME ZONE NOT NULL,  -- ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ—¥æ™‚
  check_in_method check_method_type NOT NULL DEFAULT 'qr',
  
  -- ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæƒ…å ±ï¼ˆå¸°å®…æ™‚ï¼‰
  checked_out_at TIMESTAMP WITH TIME ZONE,          -- ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥æ™‚
  check_out_method check_method_type,
  
  -- è¨˜éŒ²è€…ï¼ˆæ‰‹å‹•ã®å ´åˆï¼‰
  checked_in_by UUID REFERENCES m_users(id),
  checked_out_by UUID REFERENCES m_users(id),
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_h_attendance_child_id ON h_attendance(child_id);
CREATE INDEX idx_h_attendance_facility_id ON h_attendance(facility_id);
CREATE INDEX idx_h_attendance_checked_in_at ON h_attendance(checked_in_at);
CREATE INDEX idx_h_attendance_facility_date ON h_attendance(facility_id, DATE(checked_in_at));
```

---

## 8. ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«

### 8.1 è·å“¡-æ–½è¨­ï¼ˆ`_user_facility`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS _user_facility (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES m_users(id) ON DELETE CASCADE,
  facility_id UUID NOT NULL REFERENCES m_facilities(id) ON DELETE CASCADE,
  is_primary BOOLEAN NOT NULL DEFAULT false,  -- ä¸»æ‹…å½“æ–½è¨­ãƒ•ãƒ©ã‚°

  -- æœŸé–“ç®¡ç†ï¼ˆé€€è·ãƒ»ç•°å‹•æ™‚ã«å±¥æ­´ã¨ã—ã¦ä¿æŒï¼‰
  start_date DATE,                             -- é…å±é–‹å§‹æ—¥
  end_date DATE,                               -- é…å±çµ‚äº†æ—¥ï¼ˆé€€è·ãƒ»ç•°å‹•æ™‚ï¼‰
  is_current BOOLEAN NOT NULL DEFAULT true,    -- ç¾åœ¨æ‰€å±ä¸­ã‹

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  UNIQUE(user_id, facility_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_user_facility_user_id ON _user_facility(user_id);
CREATE INDEX idx_user_facility_facility_id ON _user_facility(facility_id);
CREATE INDEX idx_user_facility_is_primary ON _user_facility(is_primary) WHERE is_primary = true;
CREATE INDEX idx_user_facility_is_current ON _user_facility(user_id, is_current) WHERE is_current = true;
```

---

### 8.2 è·å“¡-ã‚¯ãƒ©ã‚¹ï¼ˆ`_user_class`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS _user_class (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES m_users(id) ON DELETE CASCADE,
  class_id UUID NOT NULL REFERENCES m_classes(id) ON DELETE CASCADE,

  -- ã‚¯ãƒ©ã‚¹å†…ã§ã®å½¹å‰²
  class_role VARCHAR(20),                      -- 'main' (ä¸»æ‹…ä»») / 'sub' (å‰¯æ‹…ä»») / 'assistant' (è£œåŠ©) ãªã©

  -- æœŸé–“ç®¡ç†ï¼ˆæ‹…ä»»å¤‰æ›´æ™‚ã«å±¥æ­´ã¨ã—ã¦ä¿æŒï¼‰
  start_date DATE NOT NULL,                    -- æ‹…å½“é–‹å§‹æ—¥
  end_date DATE,                               -- æ‹…å½“çµ‚äº†æ—¥
  is_current BOOLEAN NOT NULL DEFAULT true,    -- ç¾åœ¨æ‹…å½“ä¸­ã‹

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  UNIQUE(user_id, class_id, start_date)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_user_class_user_id ON _user_class(user_id);
CREATE INDEX idx_user_class_class_id ON _user_class(class_id);
CREATE INDEX idx_user_class_is_current ON _user_class(user_id, is_current) WHERE is_current = true;
CREATE INDEX idx_user_class_role ON _user_class(class_role);
```

---

### 8.3 å­ã©ã‚‚-ã‚¯ãƒ©ã‚¹ï¼ˆ`_child_class`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS _child_class (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  child_id UUID NOT NULL REFERENCES m_children(id) ON DELETE CASCADE,
  class_id UUID NOT NULL REFERENCES m_classes(id) ON DELETE CASCADE,
  school_year INTEGER NOT NULL,                  -- å¹´åº¦ï¼ˆä¾‹: 2025ï¼‰
  started_at DATE NOT NULL,                      -- ã‚¯ãƒ©ã‚¹é–‹å§‹æ—¥
  ended_at DATE,                                 -- ã‚¯ãƒ©ã‚¹çµ‚äº†æ—¥ï¼ˆé€²ç´šãƒ»é€€æ‰€æ™‚ï¼‰
  is_current BOOLEAN NOT NULL DEFAULT true,      -- ç¾åœ¨æ‰€å±ä¸­ã‹
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  UNIQUE(child_id, class_id, school_year)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_child_class_child_id ON _child_class(child_id);
CREATE INDEX idx_child_class_class_id ON _child_class(class_id);
CREATE INDEX idx_child_class_is_current ON _child_class(is_current) WHERE is_current = true;
CREATE INDEX idx_child_class_school_year ON _child_class(school_year);
```

---

### 8.4 å­ã©ã‚‚-ä¿è­·è€…ï¼ˆ`_child_guardian`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS _child_guardian (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  child_id UUID NOT NULL REFERENCES m_children(id) ON DELETE CASCADE,
  guardian_id UUID NOT NULL REFERENCES m_guardians(id) ON DELETE CASCADE,

  -- é–¢ä¿‚
  relationship VARCHAR(20),                      -- çˆ¶ / æ¯ / ç¥–çˆ¶ / ç¥–æ¯ / ãã®ä»–
  is_primary BOOLEAN NOT NULL DEFAULT false,     -- ä¸»ãŸã‚‹é€£çµ¡å…ˆ
  is_emergency_contact BOOLEAN NOT NULL DEFAULT false,  -- ç·Šæ€¥é€£çµ¡å…ˆ

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  UNIQUE(child_id, guardian_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_child_guardian_child_id ON _child_guardian(child_id);
CREATE INDEX idx_child_guardian_guardian_id ON _child_guardian(guardian_id);
CREATE INDEX idx_child_guardian_is_primary ON _child_guardian(is_primary) WHERE is_primary = true;
CREATE INDEX idx_child_guardian_is_emergency ON _child_guardian(is_emergency_contact) WHERE is_emergency_contact = true;
```

---

### 8.5 å­ã©ã‚‚-å…„å¼Ÿå§‰å¦¹ï¼ˆ`_child_sibling`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS _child_sibling (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  child_id UUID NOT NULL REFERENCES m_children(id) ON DELETE CASCADE,
  sibling_id UUID NOT NULL REFERENCES m_children(id) ON DELETE CASCADE,

  -- é–¢ä¿‚
  relationship VARCHAR(20),                      -- å…„ / å§‰ / å¼Ÿ / å¦¹

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  UNIQUE(child_id, sibling_id),
  CHECK (child_id != sibling_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_child_sibling_child_id ON _child_sibling(child_id);
CREATE INDEX idx_child_sibling_sibling_id ON _child_sibling(sibling_id);
```

### å…„å¼Ÿç´ã¥ã‘ã®é‹ç”¨æ–¹é‡ï¼ˆ2026å¹´1æœˆæ›´æ–°ï¼‰

**`relationship` ã‚«ãƒ©ãƒ ã®æ‰±ã„**:
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤: 'å…„å¼Ÿ'ï¼ˆå›ºå®šï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦ä»¶ã«ã‚ˆã‚Šã€è©³ç´°ãªé–¢ä¿‚æ€§ï¼ˆå…„/å§‰/å¼Ÿ/å¦¹ï¼‰ã¯ç®¡ç†ã—ãªã„
- å°†æ¥çš„ãªæ‹¡å¼µã®ãŸã‚ã‚«ãƒ©ãƒ ã¯ä¿æŒ

**åŒæ–¹å‘ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**:
- å…„å¼Ÿç´ã¥ã‘æ™‚ã«è‡ªå‹•çš„ã«åŒæ–¹å‘ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
- `child_id` ã¨ `sibling_id` ã‚’å…¥ã‚Œæ›¿ãˆãŸ2ã¤ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨
- ä¾‹: å¤ªéƒã¨èŠ±å­ãŒå…„å¼Ÿã®å ´åˆã€ä»¥ä¸‹ã®2ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã‚‹
  - `(child_id: å¤ªéƒ, sibling_id: èŠ±å­, relationship: 'å…„å¼Ÿ')`
  - `(child_id: èŠ±å­, sibling_id: å¤ªéƒ, relationship: 'å…„å¼Ÿ')`

**ç§»è¡Œæ–¹é‡**:
- `m_children.sibling_id`ã‚«ãƒ©ãƒ ã¯éæ¨å¥¨ï¼ˆ2026å¹´1æœˆç§»è¡Œæ¸ˆã¿ï¼‰
- æ–°è¦ç™»éŒ²ãƒ»æ›´æ–°ã¯å¿…ãš`_child_sibling`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨

---

### 8.6 è¦³å¯Ÿè¨˜éŒ²-ã‚¿ã‚°ï¼ˆ`_record_tag`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS _record_tag (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  observation_id UUID NOT NULL REFERENCES r_observation(id) ON DELETE CASCADE,
  tag_id UUID NOT NULL REFERENCES m_observation_tags(id) ON DELETE CASCADE,
  
  -- AIè‡ªå‹•ä»˜ä¸ã‹äººé–“ãŒæ‰‹å‹•ã§ä»˜ã‘ãŸã‹
  is_auto_tagged BOOLEAN NOT NULL DEFAULT false,
  confidence_score DECIMAL(3,2),                 -- AIä¿¡é ¼åº¦ï¼ˆ0.00 - 1.00ï¼‰
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  UNIQUE(observation_id, tag_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_record_tag_observation_id ON _record_tag(observation_id);
CREATE INDEX idx_record_tag_tag_id ON _record_tag(tag_id);
CREATE INDEX idx_record_tag_is_auto ON _record_tag(is_auto_tagged);
```

---

## 9. ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£å›³

```
m_companies (ä¼šç¤¾)
  â”œâ”€ m_facilities (æ–½è¨­) â† company_id
  â”‚   â”œâ”€ m_classes (ã‚¯ãƒ©ã‚¹) â† facility_id
  â”‚   â”‚   â”œâ”€ _user_class (è·å“¡-ã‚¯ãƒ©ã‚¹)
  â”‚   â”‚   â””â”€ _child_class (å­ã©ã‚‚-ã‚¯ãƒ©ã‚¹)
  â”‚   â”‚
  â”‚   â”œâ”€ m_children (å­ã©ã‚‚) â† facility_id
  â”‚   â”‚   â”œâ”€ s_attendance_schedule (æ›œæ—¥é€šæ‰€è¨­å®š)
  â”‚   â”‚   â”œâ”€ r_daily_attendance (æ—¥æ¬¡å‡ºå¸­äºˆå®š)
  â”‚   â”‚   â”œâ”€ r_observation (è¦³å¯Ÿè¨˜éŒ²)
  â”‚   â”‚   â”œâ”€ r_voice (å­ã©ã‚‚ã®å£°)
  â”‚   â”‚   â”œâ”€ h_attendance (å‡ºæ¬ å®Ÿç¸¾ãƒ­ã‚°)
  â”‚   â”‚   â”œâ”€ _child_class (å­ã©ã‚‚-ã‚¯ãƒ©ã‚¹)
  â”‚   â”‚   â”œâ”€ _child_guardian (å­ã©ã‚‚-ä¿è­·è€…)
  â”‚   â”‚   â””â”€ _child_sibling (å­ã©ã‚‚-å…„å¼Ÿå§‰å¦¹)
  â”‚   â”‚
  â”‚   â”œâ”€ m_guardians (ä¿è­·è€…) â† facility_id
  â”‚   â”‚   â””â”€ _child_guardian (å­ã©ã‚‚-ä¿è­·è€…)
  â”‚   â”‚
  â”‚   â”œâ”€ r_activity (æ´»å‹•è¨˜éŒ²) â† facility_id
  â”‚   â”œâ”€ r_daily_attendance (æ—¥æ¬¡å‡ºå¸­äºˆå®š) â† facility_id
  â”‚   â””â”€ _user_facility (è·å“¡-æ–½è¨­)
  â”‚
  â””â”€ m_users (è·å“¡) â† company_id
      â”œâ”€ _user_facility (è·å“¡-æ–½è¨­)
      â””â”€ _user_class (è·å“¡-ã‚¯ãƒ©ã‚¹)

m_observation_tags (è¦³ç‚¹ã‚¿ã‚°)
  â””â”€ _record_tag (è¦³å¯Ÿè¨˜éŒ²-ã‚¿ã‚°)

r_observation (è¦³å¯Ÿè¨˜éŒ²)
  â”œâ”€ _record_tag (è¦³å¯Ÿè¨˜éŒ²-ã‚¿ã‚°)
  â””â”€ r_activity (æ´»å‹•è¨˜éŒ²) â† activity_idï¼ˆå…ƒè¨˜éŒ²ï¼‰
```

---

## 10. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

### 10.1 åŸºæœ¬æ–¹é‡

- **å¤–éƒ¨ã‚­ãƒ¼**: ã™ã¹ã¦ã®å¤–éƒ¨ã‚­ãƒ¼ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- **æ¤œç´¢æ¡ä»¶**: WHEREå¥ã§é »ç¹ã«ä½¿ã†ã‚«ãƒ©ãƒ ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- **è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: æ–½è¨­+æ—¥ä»˜ãªã©ã€ã‚»ãƒƒãƒˆã§æ¤œç´¢ã™ã‚‹ã‚«ãƒ©ãƒ 
- **è«–ç†å‰Šé™¤**: `WHERE deleted_at IS NULL` ã‚’å«ã‚€éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

### 10.2 ä¸»è¦ãªè¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

```sql
-- æ–½è¨­ Ã— æ—¥ä»˜ï¼ˆé »å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
CREATE INDEX idx_activity_facility_date ON r_activity(facility_id, activity_date) WHERE deleted_at IS NULL;
CREATE INDEX idx_observation_child_date ON r_observation(child_id, observation_date) WHERE deleted_at IS NULL;
CREATE INDEX idx_daily_attendance_facility_date ON r_daily_attendance(facility_id, attendance_date);
```

### 10.3 å…¨æ–‡æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

```sql
-- å­ã©ã‚‚åå‰æ¤œç´¢
CREATE INDEX idx_children_name_search ON m_children 
  USING gin(to_tsvector('japanese', family_name || ' ' || given_name || ' ' || COALESCE(nickname, '')));
```

---

## 11. ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

### 11.1 è¿½åŠ äºˆå®šãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆPhase 2ä»¥é™ï¼‰

```
h_login                  ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´
h_data_export            ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå±¥æ­´
s_template               å®šå‹æ–‡ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```

**æ³¨**: ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯è¿½åŠ å®Ÿè£…æ¸ˆã¿ï¼ˆè©³ç´°ã¯`08_database_additions.md`ã‚’å‚ç…§ï¼‰
- `m_guardians` - ä¿è­·è€…ãƒã‚¹ã‚¿
- `_child_guardian` - å­ã©ã‚‚-ä¿è­·è€…ç´ä»˜ã‘
- `_child_sibling` - å­ã©ã‚‚-å…„å¼Ÿå§‰å¦¹ç´ä»˜ã‘
- `r_report` - ãƒ¬ãƒãƒ¼ãƒˆ
- `h_report_share` - ãƒ¬ãƒãƒ¼ãƒˆå…±æœ‰å±¥æ­´

### 11.2 å°†æ¥çš„ãªæ©Ÿèƒ½æ‹¡å¼µ

- ä¿è­·è€…å‘ã‘ãƒãƒ¼ã‚¿ãƒ«ï¼ˆèªè¨¼é€£æºãŒå¿…è¦ï¼‰
- å¤–éƒ¨æå‡ºè³‡æ–™ï¼ˆ`r_submission`ï¼‰
- AIã‚¿ã‚°è‡ªå‹•ä»˜ä¸ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿
- ãƒ¬ãƒãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ï¼ˆè¤‡æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¯¾å¿œï¼‰

---

## 12. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ«ãƒ¼ãƒ«

### 12.1 ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤

- **æ–½è¨­å‰Šé™¤** â†’ ã‚¯ãƒ©ã‚¹ã€æ´»å‹•è¨˜éŒ²ã‚‚å‰Šé™¤
- **å­ã©ã‚‚å‰Šé™¤** â†’ è¦³å¯Ÿè¨˜éŒ²ã€å£°è¨˜éŒ²ã€å‡ºå¸­è¨˜éŒ²ã‚‚å‰Šé™¤
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤** â†’ ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç´ä»˜ã‘ã‚’å‰Šé™¤

### 12.2 è«–ç†å‰Šé™¤å¯¾è±¡

- `m_companies`
- `m_facilities`
- `m_classes`
- `m_users`
- `m_children`
- `m_observation_tags`
- `r_activity`
- `r_observation`
- `r_voice`

### 12.3 ç‰©ç†å‰Šé™¤å¯¾è±¡ï¼ˆãƒ­ã‚°ç³»ï¼‰

- `h_attendance`
- `h_login`ï¼ˆå°†æ¥ï¼‰
- `h_report_share`ï¼ˆå°†æ¥ï¼‰

---

## 13. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 13.1 Row Level Securityï¼ˆRLSï¼‰

Supabase ã® RLS æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã€ä»¥ä¸‹ã‚’å®Ÿç¾ï¼š

```sql
-- ä¾‹: æ–½è¨­ç®¡ç†è€…ã¯è‡ªæ–½è¨­ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿é–²è¦§å¯èƒ½
CREATE POLICY facility_access ON r_activity
  FOR SELECT
  USING (
    facility_id IN (
      SELECT facility_id FROM _user_facility WHERE user_id = auth.uid()
    )
  );
```

### 13.2 å€‹äººæƒ…å ±ã®æš—å·åŒ–

- å­ã©ã‚‚ã®å†™çœŸURL
- ä¿è­·è€…ã®é€£çµ¡å…ˆ
- ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±

â†’ Supabase Storage ã®æš—å·åŒ–æ©Ÿèƒ½ã‚’ä½¿ç”¨

---

## 14. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

### 14.1 æƒ³å®šãƒ‡ãƒ¼ã‚¿é‡ï¼ˆ5å¹´å¾Œï¼‰

|ãƒ†ãƒ¼ãƒ–ãƒ«|ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°|
|---|---|
|`m_children`|10,000ä»¶|
|`m_users`|1,000ä»¶|
|`m_facilities`|200ä»¶|
|`r_activity`|100,000ä»¶|
|`r_observation`|500,000ä»¶|
|`h_attendance`|1,000,000ä»¶|

### 14.2 ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°æ¤œè¨

5å¹´å¾Œä»¥é™ã€ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ—¥ä»˜ã§ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ï¼š

- `r_activity`ï¼ˆæœˆå˜ä½ï¼‰
- `r_observation`ï¼ˆæœˆå˜ä½ï¼‰
- `h_attendance`ï¼ˆæœˆå˜ä½ï¼‰

---

## 15. å¤‰æ›´å±¥æ­´

### Phase 2ï¼ˆ2025å¹´1æœˆï¼‰

#### `m_classes`ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´
- **å‰Šé™¤**: `school_year`, `grade` - ã‚¯ãƒ©ã‚¹ã¯å¹´åº¦ã«ç´ã¥ã‹ãªã„ãŸã‚ä¸è¦
- **è¿½åŠ **: `age_group`, `room_number`, `color_code`, `display_order`
- **ç†ç”±**: ä¿è‚²åœ’ã§ã¯å¹´åº¦ã”ã¨ã«ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚Šç›´ã•ãšã€å›ºå®šã®ã‚¯ãƒ©ã‚¹åã‚’ä½¿ã„ç¶šã‘ã‚‹ãŸã‚

#### `_user_facility`ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´
- **è¿½åŠ **: `is_current`, `start_date`, `end_date`
- **ç†ç”±**: é€€è·ãƒ»ç•°å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å±¥æ­´ã¨ã—ã¦ä¿æŒã™ã‚‹ãŸã‚

#### `_user_class`ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´
- **å‰Šé™¤**: `is_homeroom`
- **è¿½åŠ **: `class_role` ('main'/'sub'/'assistant'), `is_current`, `start_date`, `end_date`
- **ç†ç”±**:
  - ä¸»æ‹…ä»»ãƒ»å‰¯æ‹…ä»»ã‚’åŒºåˆ¥ã™ã‚‹ãŸã‚
  - æ‹¡å¼µæ€§å‘ä¸Šï¼ˆè£œåŠ©ã€è¦‹ç¿’ã„ãªã©ã®å½¹å‰²ã‚’è¿½åŠ å¯èƒ½ï¼‰
  - æ‹…ä»»å¤‰æ›´ã®å±¥æ­´ã‚’ä¿æŒã™ã‚‹ãŸã‚

**è©³ç´°**: `docs/08_02_schema_updates.md` å‚ç…§

### ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½æ‹¡å¼µï¼ˆ2025å¹´12æœˆ13æ—¥ï¼‰

#### `m_children`ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´
- **è¿½åŠ **: `school_id UUID REFERENCES m_schools(id)` - æ‰€å±å­¦æ ¡ã®ç´ã¥ã‘
- **è¿½åŠ **: `grade_add INTEGER DEFAULT 0` - å­¦å¹´èª¿æ•´å€¤ï¼ˆç•™å¹´ãƒ»é£›ã³ç´šå¯¾å¿œï¼‰
- **ç†ç”±**: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å­¦æ ¡ãƒ»å­¦å¹´ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚

#### PostgreSQLé–¢æ•°ã®è¿½åŠ 
- **è¿½åŠ **: `calculate_grade(birth_date, grade_add)` - å­¦å¹´è‡ªå‹•è¨ˆç®—é–¢æ•°
- **ç†ç”±**:
  - ç”Ÿå¹´æœˆæ—¥ã‹ã‚‰ç¾åœ¨ã®å­¦å¹´ã‚’è‡ªå‹•è¨ˆç®—
  - æ—¥æœ¬ã®å­¦æ ¡åˆ¶åº¦ï¼ˆ4æœˆ1æ—¥åŸºæº–ï¼‰ã«æº–æ‹ 
  - ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»ã‚½ãƒ¼ãƒˆå‡¦ç†ã§ä½¿ç”¨

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ 
- **è¿½åŠ **: `idx_children_school_id` - å­¦æ ¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨
- **è¿½åŠ **: `idx_children_birth_grade_add` - å­¦å¹´è¨ˆç®—ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨
- **ç†ç”±**: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ€§èƒ½ã‚’æœ€é©åŒ–

**è©³ç´°**: `docs/api/08_dashboard_api.md` å‚ç…§

### AIè§£æçµæœä¿å­˜æ©Ÿèƒ½ï¼ˆ2025å¹´12æœˆï¼‰

#### `r_observation`ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´
- **è¿½åŠ **: `objective TEXT` - AIè§£æã§åˆ†é›¢ã•ã‚ŒãŸå®¢è¦³/äº‹å®Ÿéƒ¨åˆ†
- **è¿½åŠ **: `subjective TEXT` - AIè§£æã§åˆ†é›¢ã•ã‚ŒãŸä¸»è¦³/æ‰€æ„Ÿéƒ¨åˆ†
- **è¿½åŠ **: `ai_analyzed_at TIMESTAMP WITH TIME ZONE` - AIè§£æå®Ÿè¡Œæ—¥æ™‚
- **è¿½åŠ **: `is_ai_analyzed BOOLEAN DEFAULT false` - AIè§£æãŒå®Ÿè¡Œã•ã‚ŒãŸã‹ã©ã†ã‹
- **ç†ç”±**: 
  - `/records/personal/new` ã§AIè§£æçµæœï¼ˆobjective/subjectiveï¼‰ã‚’ä¿å­˜ã™ã‚‹ãŸã‚
  - å…ƒã® `content` ã¯ä¿æŒã—ã¤ã¤ã€AIè§£æã§åˆ†é›¢ã•ã‚ŒãŸå®¢è¦³/ä¸»è¦³ã‚’åˆ¥ã‚«ãƒ©ãƒ ã§ç®¡ç†
  - ã‚¿ã‚°ã¯æ—¢å­˜ã® `_record_tag` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä¿å­˜ï¼ˆå¤‰æ›´ãªã—ï¼‰
### ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹åˆ¶ç´„ã®å‰Šé™¤ï¼ˆ2025å¹´12æœˆ31æ—¥ï¼‰

#### `m_users`ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´
- **å‰Šé™¤**: `email`ã‚«ãƒ©ãƒ ã®`UNIQUE`åˆ¶ç´„
- **ç†ç”±**: å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ`deleted_at IS NOT NULL`ï¼‰ãŒåŒã˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§å†ç™»éŒ²ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
- **å½±éŸ¿**:
  - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é‡è¤‡ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§åˆ¶å¾¡
  - è«–ç†å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å†åˆ©ç”¨å¯èƒ½

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: `remove_unique_email_constraint`

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®ç¢ºèªã¨æ–‡æ›¸åŒ–ï¼ˆ2026å¹´1æœˆ4æ—¥ï¼‰

#### èƒŒæ™¯
å‡ºå¸­ç®¡ç†APIï¼ˆ`app/api/attendance/checkin/route.ts`ï¼‰ã®å®Ÿè£…ã«ãŠã„ã¦ã€`m_classes`ï¼ˆã‚¯ãƒ©ã‚¹ãƒã‚¹ã‚¿ï¼‰ã¨`_child_class`ï¼ˆå­ã©ã‚‚-ã‚¯ãƒ©ã‚¹ç´ä»˜ã‘ï¼‰ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å‚ç…§ãŒå¿…è¦ã§ã‚ã‚‹ã“ã¨ãŒåˆ¤æ˜ã€‚ã—ã‹ã—ã€`supabase/migrations`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã“ã‚Œã‚‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã‹ã£ãŸãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å®Ÿæ…‹ã‚’èª¿æŸ»ã€‚

#### èª¿æŸ»çµæœ
**é‡è¦ãªç™ºè¦‹**: ä¸¡ãƒ†ãƒ¼ãƒ–ãƒ«ã¯**æ—¢ã«Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å­˜åœ¨**ã—ã€æ­£å¸¸ã«ç¨¼åƒä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

**`m_classes`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç¾è¡Œã‚¹ã‚­ãƒ¼ãƒï¼‰**:
- âœ… ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª: 6ä»¶ã®ã‚¯ãƒ©ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ï¼ˆä¾‹: ãã‚Šã‚“çµ„ã€ãã¾çµ„ã€ãã†çµ„ï¼‰
- âœ… ã‚«ãƒ©ãƒ æ§‹æˆ: `id`, `facility_id`, `name`, `age_group`, `room_number`, `color_code`, `display_order`, `capacity`, `is_active`, `created_at`, `updated_at`, `deleted_at`
- âœ… å¤–éƒ¨ã‚­ãƒ¼: `facility_id` â†’ `m_facilities(id)` ON DELETE CASCADE
- âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: `facility_id`, `display_order` ã§æ¤œç´¢æœ€é©åŒ–æ¸ˆã¿

**`_child_class`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç¾è¡Œã‚¹ã‚­ãƒ¼ãƒï¼‰**:
- âœ… ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª: 10ä»¶ã®å­ã©ã‚‚-ã‚¯ãƒ©ã‚¹ç´ä»˜ã‘ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨
- âœ… ã‚«ãƒ©ãƒ æ§‹æˆ: `id`, `child_id`, `class_id`, `school_year`, `started_at`, `ended_at`, `is_current`, `created_at`, `updated_at`
- âœ… å¤–éƒ¨ã‚­ãƒ¼:
  - `child_id` â†’ `m_children(id)` ON DELETE CASCADE
  - `class_id` â†’ `m_classes(id)` ON DELETE CASCADE
- âœ… ä¸€æ„åˆ¶ç´„: `(child_id, class_id, school_year)`
- âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: `child_id`, `class_id`, `is_current`, `school_year` ã§æ¤œç´¢æœ€é©åŒ–æ¸ˆã¿

**æ¨æ¸¬**: ã“ã‚Œã‚‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å°å…¥ä»¥å‰ã«ã€Supabase Dashboardã®SQL Editorã‚„åˆ¥ã®æ–¹æ³•ã§ç›´æ¥ä½œæˆã•ã‚ŒãŸå¯èƒ½æ€§ãŒé«˜ã„ã€‚

#### å¯¾å¿œå†…å®¹

1. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ**ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»å±¥æ­´ç®¡ç†ç›®çš„ï¼‰:
   - âœ… `supabase/migrations/005_create_m_classes.sql` ã‚’ä½œæˆ
   - âœ… `supabase/migrations/006_create_child_class_relationship.sql` ã‚’ä½œæˆ
   - âš ï¸ **é‡è¦**: ã“ã‚Œã‚‰ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯**Supabaseã«ã¯é©ç”¨ã—ã¦ã„ãªã„**ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ—¢å­˜ã®ãŸã‚ï¼‰
   - ğŸ“ ç›®çš„: æ—¢å­˜ã‚¹ã‚­ãƒ¼ãƒæ§‹é€ ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦è¨˜éŒ²ã—ã€ä»Šå¾Œã®å¤‰æ›´å±¥æ­´ç®¡ç†ã«å‚™ãˆã‚‹

2. **Supabaseãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®å‹•ä½œæ¤œè¨¼**:
   - âœ… å‡ºå¸­ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³APIå†…ã§ä»¥ä¸‹ã®ãƒã‚¹ãƒˆã‚¯ã‚¨ãƒªãŒæ­£å¸¸å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
   ```typescript
   _child_class (
     class:m_classes (
       id,
       name
     )
   )
   ```
   - âœ… `_child_class` â†’ `m_classes` ã®é–¢é€£ã‚’ `class:m_classes` ã§å‚ç…§å¯èƒ½
   - âœ… LEFT JOIN semanticsã«ã‚ˆã‚Šã€ã‚¯ãƒ©ã‚¹æœªå‰²å½“ã®å­ã©ã‚‚ã‚‚æ­£å¸¸ã«å–å¾—å¯èƒ½

3. **ã‚¹ã‚­ãƒ¼ãƒæ•´åˆæ€§ã®ç¢ºèª**:
   - âœ… ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€Œ4.3 ã‚¯ãƒ©ã‚¹ãƒã‚¹ã‚¿ã€ãŠã‚ˆã³ã€Œ8.3 å­ã©ã‚‚-ã‚¯ãƒ©ã‚¹ã€ã®å®šç¾©ã¨å®Ÿéš›ã®ã‚¹ã‚­ãƒ¼ãƒãŒä¸€è‡´
   - âœ… å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã€ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤è¨­å®šã‚‚æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¨˜è¼‰é€šã‚Šã«å®Ÿè£…æ¸ˆã¿

#### ä»Šå›ã®ä½œæ¥­ã§å®Ÿæ–½ã—ãŸã“ã¨ãƒ»ã—ãªã‹ã£ãŸã“ã¨

**å®Ÿæ–½ã—ãŸã“ã¨**:
- âœ… æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨ç¢ºèªã¨ã‚¹ã‚­ãƒ¼ãƒèª¿æŸ»
- âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç›®çš„ï¼‰
- âœ… APIã‚¯ã‚¨ãƒªã®å‹•ä½œæ¤œè¨¼
- âœ… æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®å¤‰æ›´å±¥æ­´ã®è¿½è¨˜

**å®Ÿæ–½ã—ãªã‹ã£ãŸã“ã¨**:
- âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹ãŸã‚ä¸è¦ï¼‰
- âŒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ ï¼ˆæ—¢ã«é©åˆ‡ã«è¨­å®šæ¸ˆã¿ï¼‰
- âŒ Supabaseã¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ—¢å­˜ã®ãŸã‚ä¸è¦ï¼‰

#### çµè«–
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã¯æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å®šç¾©é€šã‚Šã«æ­£ã—ãæ§‹ç¯‰æ¸ˆã¿
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†å¤–ã§ä½œæˆã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã‚’äº‹å¾Œçš„ã«æ–‡æ›¸åŒ–
- ä»Šå¾Œã®ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã¯å¿…ãšãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±ã§å®Ÿæ–½ã—ã€Supabaseã«é©ç”¨ã™ã‚‹ã“ã¨

### æ´»å‹•è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‹¡å¼µï¼ˆ2026å¹´1æœˆ13æ—¥ï¼‰

#### `r_activity`ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´
- **è¿½åŠ **: `event_name TEXT` - ä»Šæ—¥ã®è¡Œäº‹ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå
- **è¿½åŠ **: `daily_schedule JSONB` - 1æ—¥ã®æµã‚Œ
- **è¿½åŠ **: `role_assignments JSONB` - è·å“¡ã®å½¹å‰²åˆ†æ‹…
- **è¿½åŠ **: `special_notes TEXT` - ç‰¹è¨˜äº‹é …ï¼ˆå…¨ä½“ã‚’é€šã—ã¦ã®å‡ºæ¥äº‹ï¼‰
- **è¿½åŠ **: `meal JSONB` - ã”ã¯ã‚“æƒ…å ±

**ç†ç”±**:
- æ´»å‹•è¨˜éŒ²ã«æ—¥ã€…ã®æ¥­å‹™é‹å–¶æƒ…å ±ã‚’è¿½åŠ ã—ã€ã‚ˆã‚Šè©³ç´°ãªè¨˜éŒ²ã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚
- ã‚¤ãƒ™ãƒ³ãƒˆåã€1æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€è·å“¡ã®å½¹å‰²åˆ†æ‹…ã€é£Ÿäº‹æƒ…å ±ã‚’æ§‹é€ åŒ–ã—ã¦ä¿å­˜

**JSONBã‚¹ã‚­ãƒ¼ãƒ**:
- `daily_schedule`: `[{time: string, content: string}, ...]`
- `role_assignments`: `[{user_id: string, user_name: string, role: string}, ...]`
- `meal`: `{menu: string, items_to_bring: string, notes: string}`

---

### ä¿è­·è€…ãƒã‚¹ã‚¿ã®æš—å·åŒ–å¯¾å¿œï¼ˆ2026å¹´1æœˆ24æ—¥ï¼‰

#### `m_guardians`ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´
- **å¤‰æ›´**: `family_name VARCHAR(50)` â†’ `TEXT`ï¼ˆAES-256-GCMæš—å·åŒ–å¯¾å¿œï¼‰
- **å¤‰æ›´**: `given_name VARCHAR(50)` â†’ `TEXT`ï¼ˆAES-256-GCMæš—å·åŒ–å¯¾å¿œï¼‰
- **å¤‰æ›´**: `family_name_kana VARCHAR(50)` â†’ `TEXT`ï¼ˆAES-256-GCMæš—å·åŒ–å¯¾å¿œï¼‰
- **å¤‰æ›´**: `given_name_kana VARCHAR(50)` â†’ `TEXT`ï¼ˆAES-256-GCMæš—å·åŒ–å¯¾å¿œï¼‰

**ç†ç”±**:
- AES-256-GCM + Base64url ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚Šã€æš—å·åŒ–å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºãŒ60-80æ–‡å­—ã«è†¨ã‚‰ã‚€
- `VARCHAR(50)` ã§ã¯æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ãŒåˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã€å¾©å·æ™‚ã«ãƒ‡ãƒ¼ã‚¿æ¬ æãŒç™ºç”Ÿ
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³016ã§ `phone`, `email` ã‚’ TEXT åŒ–æ¸ˆã¿ã€‚åå‰ã‚«ãƒ©ãƒ ã‚‚åŒæ§˜ã«å¯¾å¿œ

**å½±éŸ¿**:
- æ—¢å­˜ã®åˆ‡ã‚Šè©°ã‚ã‚‰ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯å†ä¿å­˜ãŒå¿…è¦
- ç·Šæ€¥é€£çµ¡å…ˆã€Œä¸­è°·ãƒ†ã‚¹ãƒˆã€ãŒã€Œä¸­è°·ã€ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹å•é¡Œã‚’è§£æ±º

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: `017_alter_guardians_name_columns.sql`

---

**ä½œæˆæ—¥**: 2025å¹´1æœˆ
**æœ€çµ‚æ›´æ–°**: 2026å¹´1æœˆ24æ—¥
**ç®¡ç†è€…**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ¼ãƒ€ãƒ¼
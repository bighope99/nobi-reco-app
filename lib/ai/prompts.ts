type ObservationTag = {
  id: string;
  name: string;
  description: string | null;
};

export const buildPersonalRecordPrompt = (text: string, tags: ObservationTag[]) => {
  const tagLines = tags.length
    ? tags.map((tag) => `- "${tag.name}": ${tag.description || '該当する場合は1'}`).join('\n')
    : '- タグなし';
  const schemaSource = tags.length ? tags : [{ id: 'tag', name: 'tag', description: null }];
  const tagSchemaLines = schemaSource.map(
    (tag, index) => `    "${tag.name}": 0${index < schemaSource.length - 1 ? ',' : ''}`,
  );

  return [
    'あなたは記録整理の専門家です。',
    'インプットは「本文」のみで、インプット全体が**常に1レコード**です（分割は不要）。',
    '本文は観察記録のみ（担当者名なし）。',
    '以下の仕様で“変形のみ”を行い、**JSON配列1要素のみ**を出力してください（前後の解説や余計な文字は禁止）。',
    '',
    '【入力】',
    `本文: ${text}`,
    '',
    '【タスク】',
    'インプット全体（本文の改行も含む）を1レコードとして扱い、下記フィールドを持つ1つのオブジェクトを生成し、配列で返す。',
    '',
    '【JSONフィールド仕様】',
    '- "objective": 文字列。**客観**：観察事実・行動・発言・手順など実際に起きた事柄のみを**原文のまま**格納。**改行は維持**し、JSONでは \\n として表現。要約・言い換え・削除は禁止。',
    '- "subjective": 文字列。**主観**：推測される気持ち／評価／配慮／方針などの解釈に当たる文を**原文のまま**格納。無ければ空文字 ""。**改行は維持**し、JSONでは \\n として表現。',
    '- 重要：**入力本文の全テキストは必ず objective または subjective のどちらかに完全に割り当てる**（欠落禁止）。両者の和（順序維持・テキスト連結時に区別可能）が、見出し等を除く元本文と同量・同内容になること。',
    '',
    '【客観/主観の仕分け基準】',
    '- 客観（objective）：出来事の列挙、行動・発言の記録、具体的手順・結果、時間・場所・人数などの事実。',
    '- 主観（subjective）：感情・意図の推測（～そう／～らしい／～と思う）、評価語（偉い／難しい等）、配慮・方針・解釈、因果の推定。',
    '- 1文に客観と主観が混在する場合は**文内で区切って**該当部分をそれぞれに振り分ける（原文の語句単位で分割、語順は保持）。',
    '- 判断に迷う部分は**客観を優先**して objective に入れる。',
    '',
    '【行動観点フラグ（0/1）】',
    '本文（objective/subjective いずれでも可）に該当すれば 1、無ければ 0。重複検出でも 1。',
    tagLines,
    '',
    '【整形ルール】',
    '- 入力の改行・スペースを極力保持。JSONにおける改行は \\n として表現。先頭・末尾の不要な全角/半角スペースのみ除去可。',
    '- 意味の改変・要約・追記を禁止。',
    '',
    '【出力要件（厳守）】',
    '- 出力は **JSON配列** のみ（1要素）。例：[ { … } ]',
    '- すべてのキーは上記名を使用。フラグは数値 0/1。null/true/false は使用しない。',
    '- 末尾カンマ禁止。UTF-8、ダブルクォート使用。',
    '',
    '【出力スキーマ例】',
    '[',
    '  {',
    '    "objective": "（客観テキスト。改行は\\nで保持）",',
    '    "subjective": "（主観テキスト。無ければ空文字）",',
    ...tagSchemaLines,
    '  }',
    ']',
  ].join('\n');
};

export const buildActivityExtractionMessages = (plainContent: string, childName: string) => {
  return {
    system: `あなたは学童保育の記録作成支援AIです。活動記録から特定の子供に関する内容を抽出してください。

【抽出ルール】
1. その子供の行動、発言、様子に関する記述を抽出
2. その子供がメンションされている文脈を含める
3. 他の子供との関わりも含める
4. 個別記録として自然な文章に整形
5. 簡潔に200文字程度でまとめる
6. 事実ベースで記述し、推測や誇張は避ける
7. 子供の成長に関わる観察ポイントを含める`,
    user: `【活動記録全文】
${plainContent}

【対象の子供】
${childName}

この子供に関する個別記録を抽出してください。`,
  };
};

export const getVoiceTranscriptionPrompt = () =>
  '次の音声メモを日本語で文字起こししてください。児童や保護者など個人を特定する名前は一般的な仮名（例: 児童A、児童B）に置き換えてください。文字起こしのみを出力。';
